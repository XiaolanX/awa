name: GKI_Kernel_Ultimate_CI

on:
  workflow_dispatch:

jobs:
  GKI_Build:
    name: GKI Ultimate Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Maximize Build Space
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 8192
        temp-reserve-mb: 2048
        remove-dotnet: 'true'
        remove-android: 'true'

    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y bc build-essential flex bison binfmt-support libssl-dev libelf-dev clang llvm lld python3-pip git-lfs
        # 安装编译 GKI 必备的工具
        pip3 install setuptools

    - name: Clone GKI Source
      run: |
        # 克隆主内核 (假设为 5.15 分支)
        git clone https://github.com/OnePlus12R-development/android_kernel_oneplus_sm8550.git --depth=1 -b sixteen-qpr1 kernel/sm8550
        # 克隆 SUSFS 补丁
        git clone https://gitlab.com/khiz_zy/susfs_patches.git --depth=1 susfs_src

    - name: Patching SUSFS & KPM
      run: |
        cd kernel/sm8550
        
        echo "--- 正在为 GKI 注入 SUSFS ---"
        # 应用 5.15 的内核补丁
        cp ../../susfs_src/Kernel_Patches/5.15/* ./
        patch -p1 < 5.15_add_susfs_in_kernel.patch || echo "警告：部分补丁需手动确认"

        # 注入 SUSFS 相关的头文件
        cp ../../susfs_src/Kernel_Patches/Include/linux/* ./include/linux/
        
        echo "--- 正在注入 KPM ---"
        # 将 KPM 源码集成到内核树
        git clone https://github.com/rifsxd/KPM.git --depth=1 ../kpm_src
        mkdir -p drivers/kpm
        cp -r ../kpm_src/kpm/* drivers/kpm/
        # 修改 Makefile 使其参与编译
        echo "obj-y += kpm/" >> drivers/Makefile

    - name: Configure GKI Defconfig
      run: |
        cd kernel/sm8550
        # 针对 GKI 核心配置进行注入
        GKI_CONF="arch/arm64/configs/gki_defconfig"
        echo "CONFIG_KSU_SUSFS=y" >> $GKI_CONF
        echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> $GKI_CONF
        echo "CONFIG_KPM=y" >> $GKI_CONF
        # 如果你用的是 KSU-Next，通常需要这个
        echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KPROBE=y" >> $GKI_CONF

    - name: Build GKI Kernel
      run: |
        cd kernel/sm8550
        # GKI 模式下，如果你的 build_sm8550 支持，可以直接调用
        # 如果不支持，这里建议使用标准的编译指令：
        # 这里假设你已经处理好了 Clang 环境变量
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- LLVM=1 LLVM_IAS=1 O=out gki_defconfig
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- LLVM=1 LLVM_IAS=1 O=out -j$(nproc) Image.gz
        
        # 将生成的 GKI 镜像打包
        mv out/arch/arm64/boot/Image.gz ${GITHUB_WORKSPACE}/GKI-Ultimate-SUSFS.gz

    - name: Release Kernel
      uses: softprops/action-gh-release@v1
      with:
        tag_name: "GKI-v5.15-${{ github.run_id }}"
        name: "GKI Ultimate (SUSFS + KPM)"
        files: |
          *.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
