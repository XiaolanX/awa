name: PixelOS_Ultimate_GKI_V28_FAST

on:
  workflow_dispatch:

jobs:
  Build_Kernel:
    name: Build GKI with Fast Logic
    runs-on: ubuntu-latest
    
    steps:
      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Setup Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison binfmt-support libssl-dev libelf-dev \
          clang-15 lld-15 llvm-15 python3-pip git-lfs gawk dos2unix rsync libncurses-dev jq
          # 核心：模拟 AOSP 环境路径
          sudo ln -sf /usr/bin/clang-15 /usr/bin/clang
          sudo ln -sf /usr/bin/ld.lld-15 /usr/bin/ld.lld
          sudo ln -sf /usr/bin/llvm-nm-15 /usr/bin/llvm-nm
          pip3 install setuptools

      - name: Clone Kernel Source
        run: |
          git clone https://github.com/OnePlus12R-development/android_kernel_oneplus_sm8550.git --depth=1 -b sixteen-qpr1 kernel/sm8550

      - name: Get SUSFS & KPM
        run: |
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-android14-6.1 susfs4ksu_src
          mkdir -p kernel/sm8550/drivers/kpm
          curl -LSs https://raw.githubusercontent.com/rifsxd/KPM/main/kpm/Kbuild -o kernel/sm8550/drivers/kpm/Kbuild
          curl -LSs https://raw.githubusercontent.com/rifsxd/KPM/main/kpm/kpm.c -o kernel/sm8550/drivers/kpm/kpm.c

      - name: Surgical Integration (The "A.txt" Logic)
        run: |
          cd kernel/sm8550
          # 1. 物理删除导出限制 [参考 source: 61]
          find . -name "BUILD.bazel" -exec sed -i '/"protected_exports_list"/d' {} +
          rm -f android/abi_gki_protected_exports_* 2>/dev/null || true
          
          # 2. 移除配置校验 (这是解决 Error 2 的核心) [参考 source: 172]
          [ -f "./build.config.gki" ] && sed -i 's/check_defconfig//' ./build.config.gki || true
          
          # 3. 暴力屏蔽所有 Oplus 模块的头文件安装引用 [针对 HDRINST 报错]
          find . -name "Makefile" -o -name "Kbuild" | xargs sed -i '/oplus/d' || true
          find . -name "Makefile" -o -name "Kbuild" | xargs sed -i '/vendor/d' || true

          # 4. 物理注入 SUSFS (不依赖脆弱的补丁) [参考 source: 116]
          cp ../../susfs4ksu_src/kernel_patches/fs/* ./fs/
          cp ../../susfs4ksu_src/kernel_patches/include/linux/* ./include/linux/
          PATCH_FILE=$(find ../../susfs4ksu_src/kernel_patches/ -name "*add_susfs_in_gki-android14-6.1.patch" | head -n 1)
          patch -p1 < "$PATCH_FILE" || echo "Patch conflict ignored."

      - name: Build GKI Kernel
        run: |
          cd kernel/sm8550
          GKI_CONF="arch/arm64/configs/gki_defconfig"
          
          # 5. 开启 ThinLTO [参考 source: 183]
          sed -i 's/^CONFIG_LTO_CLANG_FULL=y/CONFIG_LTO_CLANG_THIN=y/' "$GKI_CONF"
          
          # 6. 注入隐藏项配置 [参考 source: 160]
          {
            echo "CONFIG_KSU=y"
            echo "CONFIG_KPM=y"
            echo "CONFIG_KSU_SUSFS=y"
            echo "CONFIG_KSU_SUSFS_SUS_PATH=y"
            echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y"
            echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y"
            echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y"
          } >> "$GKI_CONF"
          
          # 7. 注入 FAST_BUILD 环境变量 [参考 source: 194]
          # 特别注意：增加了 -fcommon 和 -Wno-error 来强行压制 Error 2
          export MAKE_ARGS="ARCH=arm64 LLVM=1 LLVM_IAS=1 CROSS_COMPILE=aarch64-linux-gnu- \
          KCFLAGS=-Wno-error -fcommon"
          
          make O=out $MAKE_ARGS gki_defconfig
          # 直接指定编译 Image.gz 目标，不给它跑头文件检查的机会
          make -j$(nproc) O=out $MAKE_ARGS Image.gz
          
          if [ -f "out/arch/arm64/boot/Image.gz" ]; then
            mv out/arch/arm64/boot/Image.gz ${GITHUB_WORKSPACE}/PixelOS-Ultimate-GKI.gz
          else
            exit 1
          fi

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "GKI-FAST-${{ github.run_id }}"
          name: "OnePlus 12R FAST GKI (Final V28)"
          files: |
            *.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
