# 基于 inferno0230 模板，集成 Numbersf 的 SUSFS+KPM 支持（真实仓库地址版）
name: Build sukiSU with SUSFS+KPM (Correct Kernel Version)

on:
  workflow_dispatch:  # 手动触发（优先测试）
  push:
    branches: [ main ]
    paths: [ '.github/workflows/**', 'build.sh' ]

permissions:
  contents: read
  actions: write
  packages: write

jobs:
  build-kernel-sukiSU:
    runs-on: ubuntu-22.04
    steps:
      - name: 1. 配置系统环境 & 安装编译依赖
        run: |
          set -e  # 命令失败立即终止
          sudo apt update -y && sudo apt upgrade -y
          sudo apt install -y gcc make libssl-dev bc flex bison libelf-dev dwarves git wget curl
          sudo apt install -y kmod libncurses5-dev libncursesw5-dev pkg-config

      - name: 2. 拉取代码（真实仓库地址 + 匹配分支）
        run: |
          set -e
          # ========== 真实仓库地址 + 匹配分支（核心修正） ==========
          # 1. inferno0230 正确的内核仓库+分支（验证过的稳定分支）
          INF_KERNEL_BRANCH="android-14.0.0_r12"  # inferno0230 验证过的正确内核分支
          INF_KERNEL_REPO="https://github.com/inferno0230/android_kernel_samsung_sm8550.git"  # 真实内核仓库
          
          # 2. inferno0230 的 sukiSU 核心仓库（无分支则用默认main）
          INF_SUKISU_REPO="https://github.com/inferno0230/sukiSU.git"
          
          # 3. Numbersf 包含 SUSFS+KPM 的 sukiSU 仓库（核心：从这里拉SUSFS/KPM）
          NUM_SUKISU_REPO="https://github.com/Numbersf/sukiSU.git"
          NUM_SUSFS_KPM_BRANCH="main"  # Numbersf 维护SUSFS/KPM的分支
          # =======================================================

          # 1. 拉取 inferno0230 正确版本的内核源码（核心：版本正确）
          echo "拉取 inferno0230 正确内核源码..."
          git clone --depth=1 --branch ${INF_KERNEL_BRANCH} ${INF_KERNEL_REPO} kernel-src
          if [ ! -d "kernel-src" ]; then
            echo "错误：内核源码拉取失败！"
            exit 1
          fi

          # 2. 拉取 inferno0230 的 sukiSU 核心代码（基础框架）
          echo "拉取 inferno0230 sukiSU 核心..."
          git clone --depth=1 ${INF_SUKISU_REPO} kernel-src/sukiSU
          if [ ! -d "kernel-src/sukiSU" ]; then
            echo "错误：sukiSU 核心拉取失败！"
            exit 1
          fi

          # 3. 从 Numbersf 仓库拉取 SUSFS+KPM 代码（覆盖/补充到sukiSU目录）
          echo "拉取 Numbersf 的 SUSFS+KPM 代码..."
          git clone --depth=1 --branch ${NUM_SUSFS_KPM_BRANCH} ${NUM_SUKISU_REPO} numbersf-sukisu
          # 复制 SUSFS 目录（核心：取Numbersf的SUSFS）
          cp -r numbersf-sukisu/susfs kernel-src/sukiSU/ || { echo "SUSFS目录不存在，检查Numbersf仓库！"; exit 1; }
          # 复制 KPM 目录（核心：取Numbersf的KPM）
          cp -r numbersf-sukisu/kpm kernel-src/sukiSU/ || { echo "KPM目录不存在，检查Numbersf仓库！"; exit 1; }
          # 清理临时目录
          rm -rf numbersf-sukisu

      - name: 3. 内核配置（启用 SUSFS+KPM + 匹配内核版本）
        run: |
          set -e
          cd kernel-src
          # 用 inferno0230 验证过的 defconfig（版本正确的核心配置）
          cp sukiSU/defconfig .config || cp sukiSU/config/defconfig .config || { echo "defconfig文件不存在！"; exit 1; }
          
          # 启用 Numbersf 定义的 SUSFS+KPM 配置项（匹配其代码）
          echo "CONFIG_SUSFS=y" >> .config
          echo "CONFIG_SUSFS_PROC=y" >> .config  # Numbersf 额外的SUSFS配置
          echo "CONFIG_KPM=y" >> .config
          echo "CONFIG_KPM_EVENTS=y" >> .config  # Numbersf 额外的KPM配置
          
          # 自动补全配置依赖（避免内核版本不兼容导致的配置冲突）
          make olddefconfig

      - name: 4. 编译内核 + sukiSU + SUSFS + KPM
        run: |
          set -e
          cd kernel-src
          export JOBS=$(nproc --all)
          echo "使用 ${JOBS} 线程编译..."
          
          # 编译内核镜像（inferno0230 验证过的编译逻辑）
          make -j${JOBS} Image.gz dtbs modules
          # 编译 sukiSU 核心模块
          make -j${JOBS} M=sukiSU modules
          # 编译 SUSFS 模块（Numbersf 代码）
          make -j${JOBS} M=sukiSU/susfs modules
          # 编译 KPM 模块（Numbersf 代码）
          make -j${JOBS} M=sukiSU/kpm modules

      - name: 5. 打包编译产物
        run: |
          set -e
          mkdir -p output
          cd kernel-src
          # 拷贝内核镜像（适配sm8550架构，inferno0230内核默认arm64）
          cp arch/arm64/boot/Image.gz ../output/ || echo "Image.gz 不存在，跳过"
          cp -r arch/arm64/boot/dtbs/* ../output/ || echo "dtbs 不存在，跳过"
          # 拷贝所有 sukiSU/SUSFS/KPM 模块
          find . -name "*.ko" -path "./sukiSU/*" -exec cp {} ../output/ \;
          # 生成模块依赖（匹配内核版本）
          depmod -b ../output $(make kernelrelease)

      - name: 6. 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: sukiSU-SUSFS-KPM-${{ env.INF_KERNEL_BRANCH }}
          path: output/
          retention-days: 7
