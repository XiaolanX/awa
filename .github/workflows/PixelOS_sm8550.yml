# 基于 inferno0230 的模板，集成 Numbersf 的 SUSFS+KPM 支持
name: Build sukiSU with SUSFS+KPM (Correct Kernel Version)

# 触发条件：可根据需求调整（手动触发、push、定时等）
on:
  workflow_dispatch:  # 手动触发
  push:
    branches: [ main ]
    paths: [ '.github/workflows/**', 'build.sh' ]  # 仅改动 workflow 或编译脚本时触发

# 权限配置（按需调整）
permissions:
  contents: read
  actions: write
  packages: write

jobs:
  build-kernel-sukiSU:
    runs-on: ubuntu-22.04  # 兼容内核编译的基础环境（inferno0230 同款）
    steps:
      - name: 1. 配置系统环境 & 安装编译依赖
        run: |
          sudo apt update -y
          sudo apt upgrade -y
          # 安装内核编译必需依赖（inferno0230 基础依赖）
          sudo apt install -y gcc make libssl-dev bc flex bison libelf-dev dwarves git wget curl
          # 安装 SUSFS/KPM 编译额外依赖（Numbersf 仓库补充）
          sudo apt install -y kmod libncurses5-dev libncursesw5-dev pkg-config

      - name: 2. 拉取代码（内核+SukiSU+SUSFS+KPM）
        run: |
          # 拉取 inferno0230 正确版本的内核源码（替换为实际仓库/分支）
          git clone --depth=1 --branch=[正确内核版本分支] [inferno0230 内核仓库地址] kernel-src
          cd kernel-src
          # 拉取 sukiSU 核心代码（inferno0230 验证过的版本）
          git clone --depth=1 [inferno0230 sukiSU 仓库地址] sukiSU
          # 拉取 Numbersf 仓库中的 SUSFS 代码（替换为实际地址）
          git clone --depth=1 [Numbersf SUSFS 仓库地址] sukiSU/susfs
          # 拉取 Numbersf 仓库中的 KPM 模块代码（替换为实际地址）
          git clone --depth=1 [Numbersf KPM 仓库地址] sukiSU/kpm

      - name: 3. 内核配置（继承 inferno0230 正确配置，启用 SUSFS+KPM）
        run: |
          cd kernel-src
          # 复制 inferno0230 验证过的正确 defconfig（替换为实际配置文件名）
          cp sukiSU/config/defconfig .config
          # 启用 SUSFS 内核配置项（Numbersf 关键配置）
          echo "CONFIG_SUSFS=y" >> .config
          echo "CONFIG_SUSFS_DEBUG=n" >> .config
          # 启用 KPM 内核配置项（Numbersf 关键配置）
          echo "CONFIG_KPM=y" >> .config
          echo "CONFIG_KPM_MODULES=y" >> .config
          # 生成最终配置（自动补全依赖项）
          make olddefconfig

      - name: 4. 编译内核 + sukiSU（含 SUSFS+KPM）
        run: |
          cd kernel-src
          # 设置编译线程数（适配 GitHub Runner 资源）
          export JOBS=$(nproc --all)
          # 编译内核镜像（inferno0230 基础编译逻辑）
          make -j$JOBS Image.gz dtbs modules
          # 编译 sukiSU 核心模块
          make -j$JOBS M=sukiSU modules
          # 编译 SUSFS 模块（Numbersf 编译逻辑）
          make -j$JOBS M=sukiSU/susfs modules
          # 编译 KPM 模块（Numbersf 编译逻辑）
          make -j$JOBS M=sukiSU/kpm modules

      - name: 5. 打包编译产物
        run: |
          mkdir -p output
          cd kernel-src
          # 拷贝内核镜像
          cp arch/arm64/boot/Image.gz ../output/
          cp arch/arm64/boot/dtbs/* ../output/
          # 拷贝 sukiSU + SUSFS + KPM 模块
          find . -name "*.ko" -path "./sukiSU/*" -exec cp {} ../output/ \;
          # 生成模块依赖
          depmod -b ../output $(make kernelrelease)

      - name: 6. 上传产物到 GitHub Artifact
        uses: actions/upload-artifact@v4
        with:
          name: sukiSU-SUSFS-KPM-[内核版本]
          path: output/
          retention-days: 7  # 产物保留天数，按需调整
