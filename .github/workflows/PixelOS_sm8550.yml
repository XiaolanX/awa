name: PixelOS_Ultimate_GKI_V14

on:
  workflow_dispatch:

jobs:
  Build_Kernel:name: PixelOS_Ultimate_GKI_V15

on:
  workflow_dispatch:

jobs:
  Build_Kernel:
    name: Build GKI with SukiSU-Style Fixes
    runs-on: ubuntu-latest
    
    steps:
      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Setup Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison binfmt-support libssl-dev libelf-dev clang llvm lld python3-pip git-lfs gawk dos2unix rsync libncurses-dev
          pip3 install setuptools

      - name: Download Official AOSP Clang
        run: |
          # 参考 FAST_BUILD 逻辑，准备 AOSP 工具链
          mkdir -p $GITHUB_WORKSPACE/clang-aosp
          wget https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r522817.tar.gz
          tar -xzf clang-r522817.tar.gz -C $GITHUB_WORKSPACE/clang-aosp
          echo "CLANG_PATH=$GITHUB_WORKSPACE/clang-aosp/bin" >> $GITHUB_ENV

      - name: Clone Kernel Source
        run: |
          git clone https://github.com/OnePlus12R-development/android_kernel_oneplus_sm8550.git --depth=1 -b sixteen-qpr1 kernel/sm8550

      - name: Get SUSFS & KPM
        run: |
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-android14-6.1 susfs4ksu_src
          mkdir -p kernel/sm8550/drivers/kpm
          curl -LSs https://raw.githubusercontent.com/rifsxd/KPM/main/kpm/Kbuild -o kernel/sm8550/drivers/kpm/Kbuild
          curl -LSs https://raw.githubusercontent.com/rifsxd/KPM/main/kpm/kpm.c -o kernel/sm8550/drivers/kpm/kpm.c

      - name: Surgical Integration & Oplus Fix
        run: |
          cd kernel/sm8550
          
          echo "--- 1. 全量修复 Kconfig 路径 ---"
          python3 -c '
          import os, re
          for root, dirs, files in os.walk("."):
              for file in files:
                  if file == "Kconfig":
                      path = os.path.join(root, file)
                      with open(path, "r") as f:
                          lines = f.readlines()
                      with open(path, "w") as f:
                          for line in lines:
                              match = re.search(r"source\s+\"([^\"]+)\"", line)
                              if match:
                                  target = match.group(1)
                                  if not os.path.exists(os.path.join(root, target)): continue
                              f.write(line)
          '
          
          echo "--- 2. 清理 ABI 保护与导出限制 ---"
          # 物理删除受保护的导出列表限制 
          find . -name "BUILD.bazel" -exec sed -i '/"protected_exports_list"/d' {} +
          rm -f android/abi_gki_protected_exports_* 2>/dev/null || true

          echo "--- 3. 移除构建审查 ---"
          # 屏蔽 check_defconfig 防止编译中断 [cite: 172]
          [ -f "./build.config.gki" ] && sed -i 's/check_defconfig//' ./build.config.gki || true

          echo "--- 4. 物理注入 SUSFS 文件 ---"
          # 直接同步补丁文件目录到内核源码树 [cite: 116]
          cp ../../susfs4ksu_src/kernel_patches/fs/* ./fs/
          cp ../../susfs4ksu_src/kernel_patches/include/linux/* ./include/linux/
          PATCH_FILE=$(find ../../susfs4ksu_src/kernel_patches/ -name "*add_susfs_in_gki-android14-6.1.patch" | head -n 1)
          patch -p1 < "$PATCH_FILE" || echo "Patch conflict ignored."

          echo "--- 5. 注入 KPM ---"
          if ! grep -q "obj-y += kpm/" drivers/Makefile; then
            echo "obj-y += kpm/" >> drivers/Makefile
          fi

    - name: Configure GKI Defconfig
      run: |
        cd kernel/sm8550
        GKI_CONF="arch/arm64/configs/gki_defconfig"
        
        # 注入全套 SUSFS 隐藏配置链 [cite: 159, 160]
        sed -i '/CONFIG_KSU/d' "$GKI_CONF"
        {
          echo "CONFIG_KSU=y"
          echo "CONFIG_KPM=y"
          echo "CONFIG_KSU_SUSFS=y"
          echo "CONFIG_KSU_SUSFS_SUS_PATH=y"
          echo "CONFIG_KSU_SUSFS_SUS_MAP=y"
          echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y"
          echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y"
          echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y"
          echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y"
          echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y"
        } >> "$GKI_CONF"

    - name: Build GKI Kernel
      run: |
        cd kernel/sm8550
        export PATH="${{ env.CLANG_PATH }}:$PATH"
        
        # 强制启用 ThinLTO 优化加速编译 
        sed -i 's/^CONFIG_LTO_CLANG_FULL=y/CONFIG_LTO_CLANG_THIN=y/' arch/arm64/configs/gki_defconfig
        
        # 设置 FAST_BUILD 风格的编译参数并忽略警告错误 
        export MAKE_ARGS="ARCH=arm64 LLVM=1 LLVM_IAS=1 CROSS_COMPILE=aarch64-linux-gnu- KCFLAGS=-Wno-error"
        
        make O=out $MAKE_ARGS gki_defconfig
        make -j$(nproc) O=out $MAKE_ARGS Image.gz
        
        if [ -f "out/arch/arm64/boot/Image.gz" ]; then
          mv out/arch/arm64/boot/Image.gz ${GITHUB_WORKSPACE}/PixelOS-Ultimate-GKI.gz
        else
          exit 1
        fi

    - name: Upload Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: "GKI-Ultimate-${{ github.run_id }}"
        name: "OnePlus 12R Ultimate GKI (Fix V15)"
        files: |
          *.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    name: Build GKI with SukiSU-Style Fixes
    runs-on: ubuntu-latest
    
    steps:
      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Setup Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison binfmt-support libssl-dev libelf-dev clang llvm lld python3-pip git-lfs gawk dos2unix rsync libncurses-dev
          pip3 install setuptools

      - name: Download Official AOSP Clang
        run: |
          # 下载 GKI 编译标准的 Clang 版本 (参考 FAST_BUILD 逻辑)
          mkdir -p $GITHUB_WORKSPACE/clang-aosp
          wget https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r522817.tar.gz
          tar -xzf clang-r522817.tar.gz -C $GITHUB_WORKSPACE/clang-aosp
          echo "CLANG_PATH=$GITHUB_WORKSPACE/clang-aosp/bin" >> $GITHUB_ENV

      - name: Clone Kernel Source
        run: |
          git clone https://github.com/OnePlus12R-development/android_kernel_oneplus_sm8550.git --depth=1 -b sixteen-qpr1 kernel/sm8550

      - name: Get SUSFS & KPM
        run: |
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-android14-6.1 susfs4ksu_src
          mkdir -p kernel/sm8550/drivers/kpm
          curl -LSs https://raw.githubusercontent.com/rifsxd/KPM/main/kpm/Kbuild -o kernel/sm8550/drivers/kpm/Kbuild
          curl -LSs https://raw.githubusercontent.com/rifsxd/KPM/main/kpm/kpm.c -o kernel/sm8550/drivers/kpm/kpm.c

      - name: Surgical Integration & Oplus Fix
        run: |
          cd kernel/sm8550
          
          echo "--- 1. 全量修复 Kconfig 路径 ---"
          python3 -c '
          import os, re
          for root, dirs, files in os.walk("."):
              for file in files:
                  if file == "Kconfig":
                      path = os.path.join(root, file)
                      with open(path, "r") as f:
                          lines = f.readlines()
                      with open(path, "w") as f:
                          for line in lines:
                              match = re.search(r"source\s+\"([^\"]+)\"", line)
                              if match:
                                  target = match.group(1)
                                  if not os.path.exists(os.path.join(root, target)): continue
                              f.write(line)
          '
          
          echo "--- 2. 参考代码清理: ABI 保护与导出限制 ---"
          # 参考 source 61 的做法，删除受保护的导出列表引用
          [cite_start]find . -name "BUILD.bazel" -exec sed -i '/"protected_exports_list"/d' {} + [cite: 61]
          [cite_start]rm -f android/abi_gki_protected_exports_* 2>/dev/null || true [cite: 61]

          echo "--- 3. 参考代码清理: 移除构建审查 ---"
          # 参考 source 172 的做法，移除 check_defconfig 防止中断 
          [ -f "./build.config.gki" ] && sed -i 's/check_defconfig//' ./build.config.gki || true

          echo "--- 4. 物理注入 SUSFS 文件 ---"
          # 参考 source 116 的做法，直接物理拷贝 fs 和 include 目录 [cite: 116]
          [cite_start]cp ../../susfs4ksu_src/kernel_patches/fs/* ./fs/ [cite: 116]
          [cite_start]cp ../../susfs4ksu_src/kernel_patches/include/linux/* ./include/linux/ [cite: 116]
          PATCH_FILE=$(find ../../susfs4ksu_src/kernel_patches/ -name "*add_susfs_in_gki-android14-6.1.patch" | head -n 1)
          patch -p1 < "$PATCH_FILE" || echo "Patch conflict ignored."

          echo "--- 5. 注入 KPM ---"
          if ! grep -q "obj-y += kpm/" drivers/Makefile; then
            echo "obj-y += kpm/" >> drivers/Makefile
          fi

      - name: Configure GKI Defconfig
        run: |
          cd kernel/sm8550
          GKI_CONF="arch/arm64/configs/gki_defconfig"
          
          # 参考 source 159-161 注入全套隐藏配置 [cite: 159, 160, 161]
          sed -i '/CONFIG_KSU/d' "$GKI_CONF"
          {
            echo "CONFIG_KSU=y"
            echo "CONFIG_KPM=y"
            echo "CONFIG_KSU_SUSFS=y"
            echo "CONFIG_KSU_SUSFS_SUS_PATH=y"
            echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y"
            echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y"
            echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y"
            echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y"
            echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y"
          } >> "$GKI_CONF"

      - name: Build GKI Kernel
        run: |
          cd kernel/sm8550
          export PATH="${{ env.CLANG_PATH }}:$PATH"
          
          # 参考 source 183 开启 ThinLTO 优化编译 
          [cite_start]sed -i 's/^CONFIG_LTO_CLANG_FULL=y/CONFIG_LTO_CLANG_THIN=y/' arch/arm64/configs/gki_defconfig [cite: 183]
          
          # 参考 source 194 设置编译参数并强制忽略错误 
          [cite_start]export MAKE_ARGS="ARCH=arm64 LLVM=1 LLVM_IAS=1 CROSS_COMPILE=aarch64-linux-gnu- KCFLAGS=-Wno-error" [cite: 194]
          
          make O=out $MAKE_ARGS gki_defconfig
          make -j$(nproc) O=out $MAKE_ARGS Image.gz
          
          if [ -f "out/arch/arm64/boot/Image.gz" ]; then
            mv out/arch/arm64/boot/Image.gz ${GITHUB_WORKSPACE}/PixelOS-Ultimate-GKI.gz
          else
            echo "编译失败，Image.gz 未生成"
            exit 1
          fi

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "GKI-Clang-${{ github.run_id }}"
          name: "OnePlus 12R Ultimate GKI (Fix V14)"
          files: |
            *.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
