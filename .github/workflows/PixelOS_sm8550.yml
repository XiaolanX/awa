name: PixelOS_Kernel_CI-aston

on:
  workflow_dispatch:
    inputs:
      enable_susfs:
        description: '启用 SUSFS 支持'
        type: boolean
        default: true
      enable_kpm:
        description: '启用 KPM (内核模块) 支持'
        type: boolean
        default: true
      susfs_branch:
        description: 'SUSFS 分支名称 (使用 master 而不是 main)'
        type: string
        default: 'master'
      kpm_type:
        description: 'KPM 实现类型'
        type: choice
        options:
          - kpatch
          - livepatch
          - basic
        default: 'basic'

jobs:
  PixelOS_Kernel_CI:
    name: PixelOS Kernel CI
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Install All Build Dependencies
      run: |
        echo "安装所有内核构建依赖工具..."
        sudo apt-get update
        sudo apt-get install -y \
            build-essential libssl-dev bc kmod \
            flex bison libelf-dev git ccache aria2 patch rsync \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            binutils-aarch64-linux-gnu libncurses-dev \
            python3 python3-pip cpio lz4
        
        # 验证交叉编译器安装
        echo "验证交叉编译器:"
        aarch64-linux-gnu-gcc --version
        echo "✅ 所有构建依赖安装完成"

    - name: Clone Kernel and Dependencies
      run: |
        echo "克隆内核源码..."
        git clone https://github.com/OnePlus12R-development/android_kernel_oneplus_sm8550.git --depth=1 -b sixteen-qpr1 kernel/oneplus/sm8550
        git clone https://github.com/OnePlus12R-development/android_kernel_oneplus_sm8550-modules.git --depth=1 -b sixteen-qpr1 kernel/oneplus/sm8550-modules
        
        # 验证克隆结果
        if [ ! -d "kernel/oneplus/sm8550" ]; then
            echo "❌ 内核代码克隆失败"
            exit 1
        fi
        
        echo "✅ 内核代码克隆成功"
        
        # 检查内核目录结构
        cd kernel/oneplus/sm8550
        echo "内核目录结构:"
        ls -la
        echo "arch/arm64/configs 目录内容:"
        find arch/arm64/configs -name "*.defconfig" 2>/dev/null | head -10
        cd -

    - name: Find Defconfig Files
      run: |
        cd kernel/oneplus/sm8550
        echo "查找可用的 defconfig 文件..."
        
        # 查找所有可能的 defconfig
        echo "所有 defconfig 文件:"
        find arch/arm64/configs -name "*defconfig*" 2>/dev/null
        
        # 尝试常见的 defconfig 文件名
        for config in "vendor/sm8550_defconfig" "sm8550_defconfig" "vendor/sm8550-perf_defconfig" "vendor/sm8550-vendor_defconfig" "vendor/oneplus/sm8550_defconfig"; do
            if [ -f "arch/arm64/configs/$config" ]; then
                echo "✅ 找到 defconfig: $config"
                echo "DEFCONFIG_PATH=$config" >> $GITHUB_ENV
                break
            fi
        done
        
        if [ -z "$DEFCONFIG_PATH" ]; then
            echo "❌ 未找到标准的 defconfig 文件"
            echo "尝试查找第一个可用的 defconfig..."
            FIRST_CONFIG=$(find arch/arm64/configs -name "*defconfig" 2>/dev/null | head -1)
            if [ -n "$FIRST_CONFIG" ]; then
                DEFCONFIG_PATH=$(echo "$FIRST_CONFIG" | sed 's|^arch/arm64/configs/||')
                echo "使用找到的第一个配置: $DEFCONFIG_PATH"
                echo "DEFCONFIG_PATH=$DEFCONFIG_PATH" >> $GITHUB_ENV
            else
                echo "无法找到任何 defconfig 文件"
                exit 1
            fi
        fi

    - name: Setup SUSFS Environment
      if: inputs.enable_susfs
      run: |
        echo "正在设置 SUSFS 环境..."
        
        # 增强分支处理逻辑
        if git clone https://gitlab.com/simonpunk/susfs4ksu.git -b ${{ inputs.susfs_branch }} susfs_patches; then
            echo "✅ SUSFS 分支 ${{ inputs.susfs_branch }} 克隆成功"
        else
            echo "⚠️ 分支 ${{ inputs.susfs_branch }} 不存在，尝试默认的 master 分支"
            if ! git clone https://gitlab.com/simonpunk/susfs4ksu.git -b master susfs_patches; then
                echo "⚠️ SUSFS 克隆失败，跳过 SUSFS 支持"
                echo "SUSFS_ENABLED=false" >> $GITHUB_ENV
            else
                echo "SUSFS_ENABLED=true" >> $GITHUB_ENV
            fi
        fi
        
        if [ "${{ env.SUSFS_ENABLED }}" != "false" ] && [ -d "susfs_patches/kernel_patches" ]; then
            echo "复制 SUSFS 补丁文件..."
            cp -r susfs_patches/kernel_patches/* kernel/oneplus/sm8550/ 2>/dev/null || echo "⚠️ 部分文件复制失败，继续执行..."
            echo "✅ SUSFS 补丁文件复制完成"
        elif [ "${{ env.SUSFS_ENABLED }}" != "false" ]; then
            echo "❌ SUSFS 补丁目录不存在，检查仓库结构:"
            ls -la susfs_patches/
        fi

    - name: Setup KPM Environment  
      if: inputs.enable_kpm
      run: |
        echo "正在设置 KPM 环境..."
        
        # 简化KPM设置，主要依赖内核内置支持
        case "${{ inputs.kpm_type }}" in
            "kpatch")
                echo "使用 kpatch 实现"
                mkdir -p kpm_tools
                echo "KPM 通过内核内置KPROBES支持" > kpm_tools/README.md
                ;;
            "livepatch")
                echo "使用 livepatch 实现"
                mkdir -p kpm_tools
                echo "KPM 通过内核内置LIVEPATCH支持" > kpm_tools/README.md
                ;;
            *)
                echo "使用基础 KPROBES 支持"
                mkdir -p kpm_tools
                echo "KPM 基础支持已配置" > kpm_tools/README.md
                ;;
        esac
        
        echo "✅ KPM 环境设置完成"

    - name: Configure Kernel Options
      run: |
        cd kernel/oneplus/sm8550
        echo "配置内核选项..."
        
        CONFIG_FILE="arch/arm64/configs/${{ env.DEFCONFIG_PATH }}"
        echo "使用的配置文件: $CONFIG_FILE"
        
        if [ ! -f "$CONFIG_FILE" ]; then
            echo "❌ 配置文件不存在"
            exit 1
        fi
        
        # 备份原始配置
        cp "$CONFIG_FILE" "${CONFIG_FILE}.backup"
        echo "✅ 原始配置已备份"
        
        # 基础配置
        {
            echo "# 基础模块支持"
            echo "CONFIG_MODULES=y"
            echo "CONFIG_MODULE_UNLOAD=y"
        } >> "$CONFIG_FILE"
        
        # SUSFS 配置
        if [ "${{ inputs.enable_susfs }}" = "true" ] && [ "${{ env.SUSFS_ENABLED }}" != "false" ]; then
            {
                echo "# SUSFS 配置"
                echo "CONFIG_KSU_SUSFS=y"
                echo "CONFIG_KSU_SUSFS_SUS_PATH=y"
            } >> "$CONFIG_FILE"
            echo "✅ SUSFS 配置已添加"
        fi
        
        # KPM 配置
        if [ "${{ inputs.enable_kpm }}" = "true" ]; then
            {
                echo "# KPM/KPROBES 配置"
                echo "CONFIG_KPROBES=y"
                echo "CONFIG_HAVE_KPROBES=y"
                echo "CONFIG_KPROBE_EVENTS=y"
            } >> "$CONFIG_FILE"
            
            case "${{ inputs.kpm_type }}" in
                "kpatch"|"livepatch")
                    {
                        echo "CONFIG_LIVEPATCH=y"
                    } >> "$CONFIG_FILE"
                    ;;
            esac
            echo "✅ KPM 配置已添加"
        fi
        
        echo "✅ 内核配置更新完成"
        echo "配置文件行数: $(wc -l < "$CONFIG_FILE")"

    - name: Setup release name
      run: |
        rm -rf ${GITHUB_WORKSPACE}/*.zip
        cd kernel/oneplus/sm8550
        
        # 获取内核版本信息
        if [ -f "Makefile" ]; then
            KERNEL_VERSION=$(grep "^VERSION =" Makefile | awk '{print $3}' | head -1)
            PATCHLEVEL=$(grep "^PATCHLEVEL =" Makefile | awk '{print $3}' | head -1)
            SUBLEVEL=$(grep "^SUBLEVEL =" Makefile | awk '{print $3}' | head -1)
            VERSION_STR="${KERNEL_VERSION}.${PATCHLEVEL}.${SUBLEVEL}"
        else
            VERSION_STR="unknown"
        fi
        
        # 生成功能标记
        FEATURE_SUFFIX=""
        [ "${{ inputs.enable_susfs }}" = "true" ] && FEATURE_SUFFIX="${FEATURE_SUFFIX}_SUSFS"
        [ "${{ inputs.enable_kpm }}" = "true" ] && FEATURE_SUFFIX="${FEATURE_SUFFIX}_KPM"
        
        REL_NAME="PixelOS_SM8550-${VERSION_STR}-$(date +"%Y%m%d")${FEATURE_SUFFIX}"
        echo "REL_NAME=${REL_NAME}" >> $GITHUB_ENV
        echo "✅ 发布名称设置为: $REL_NAME"

    - name: Build Kernel
      run: |
        cd kernel/oneplus/sm8550
        echo "开始构建内核..."
        
        # 设置构建环境
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CC=aarch64-linux-gnu-gcc
        
        # 验证编译器
        echo "验证交叉编译器..."
        ${CROSS_COMPILE}gcc --version || { 
            echo "❌ 交叉编译器不可用"; 
            echo "尝试查找编译器:"
            which aarch64-linux-gnu-gcc || echo "未找到编译器"
            exit 1
        }
        
        echo "使用的 defconfig: ${{ env.DEFCONFIG_PATH }}"
        
        # 清理之前的构建
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- mrproper 2>/dev/null || echo "清理完成"
        
        # 配置内核
        echo "配置内核..."
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- ${{ env.DEFCONFIG_PATH }}
        
        # 应用额外配置
        if [ "${{ inputs.enable_susfs }}" = "true" ] && [ "${{ env.SUSFS_ENABLED }}" != "false" ]; then
            echo "应用 SUSFS 配置..."
            scripts/config --enable KSU_SUSFS
        fi
        
        if [ "${{ inputs.enable_kpm }}" = "true" ]; then
            echo "应用 KPM 配置..."
            scripts/config --enable KPROBES
            scripts/config --enable HAVE_KPROBES
        fi
        
        # 生成最终配置
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig
        
        # 编译内核
        echo "编译内核..."
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- -j$(nproc) Image.gz-dtb
        
        # 验证构建结果
        if [ -f "arch/arm64/boot/Image.gz-dtb" ]; then
            echo "✅ 内核构建成功"
            ls -lh arch/arm64/boot/Image.gz-dtb
        else
            echo "❌ 内核构建失败，未找到输出文件"
            exit 1
        fi

    - name: Create Kernel Flashable ZIP
      run: |
        echo "创建可刷写的内核包..."
        
        # 创建临时目录结构
        mkdir -p ${GITHUB_WORKSPACE}/kernel_package
        
        # 复制内核镜像
        cp kernel/oneplus/sm8550/arch/arm64/boot/Image.gz-dtb ${GITHUB_WORKSPACE}/kernel_package/
        
        # 创建基本的刷机脚本
        cat > ${GITHUB_WORKSPACE}/kernel_package/anykernel.sh << 'EOF'
        # AnyKernel3 Ramdisk Mod Script
        # osm0sis @ xda-developers

        ## AnyKernel setup
        # begin properties
        properties() { '
        kernel.string=PixelOS Kernel for SM8550
        do.devicecheck=1
        do.modules=0
        do.systemless=1
        do.cleanup=1
        do.cleanuponabort=0
        device.name1=oneplus
        supported.versions=
        supported.patchlevels=
        '; } # end properties

        # shell variables
        block=/dev/block/bootdevice/by-name/boot;
        is_slot_device=0;
        ramdisk_compression=auto;
        
        ## AnyKernel methods (DO NOT CHANGE)
        # import patching functions/variables - see for reference
        . tools/ak3-core.sh;
        
        ## AnyKernel install
        dump_boot;
        
        write_boot;
        ## end install
        EOF
        
        # 创建基本的 anykernel3 结构
        mkdir -p ${GITHUB_WORKSPACE}/kernel_package/{tools,modules,patch}
        
        # 复制必要的工具
        cat > ${GITHUB_WORKSPACE}/kernel_package/tools/ak3-core.sh << 'EOF'
        # AnyKernel3 Core Script
        echo "AnyKernel3安装脚本已准备"
        EOF
        
        # 创建ZIP文件
        cd ${GITHUB_WORKSPACE}/kernel_package
        ZIP_NAME="PixelOS_SM8550_$(date +"%Y%m%d")"
        [ "${{ inputs.enable_susfs }}" = "true" ] && ZIP_NAME="${ZIP_NAME}_SUSFS"
        [ "${{ inputs.enable_kpm }}" = "true" ] && ZIP_NAME="${ZIP_NAME}_KPM"
        ZIP_NAME="${ZIP_NAME}.zip"
        
        zip -r9 ${GITHUB_WORKSPACE}/${ZIP_NAME} .
        
        echo "✅ 内核包创建完成: ${ZIP_NAME}"
        ls -lh ${GITHUB_WORKSPACE}/${ZIP_NAME}
        
        echo "KERNEL_ZIP=${ZIP_NAME}" >> $GITHUB_ENV

    - name: Create GitHub Release
      run: |
        cd ${GITHUB_WORKSPACE}
        echo "创建 GitHub 发布..."
        
        if [ -z "$KERNEL_ZIP" ]; then
            echo "❌ 未找到内核包"
            exit 1
        fi
        
        if [ ! -f "$KERNEL_ZIP" ]; then
            echo "❌ 内核包文件不存在: $KERNEL_ZIP"
            ls -la
            exit 1
        fi
        
        echo "发布文件: $KERNEL_ZIP"
        
        # 创建发布说明
        RELEASE_NOTES="PixelOS Kernel for SM8550
构建时间: $(date)
内核版本: $(cd kernel/oneplus/sm8550 && grep "^VERSION =\|^PATCHLEVEL =\|^SUBLEVEL =" Makefile 2>/dev/null | tr '\n' ' ')
特性支持:
- SUSFS: ${{ inputs.enable_susfs }}
- KPM: ${{ inputs.enable_kpm }} (${{ inputs.kpm_type }})
Defconfig: ${{ env.DEFCONFIG_PATH }}
GitHub Actions运行ID: ${{ github.run_id }}"
        
        # 创建发布
        gh release create "$REL_NAME" \
            --title "$REL_NAME" \
            --notes "$RELEASE_NOTES" \
            "$KERNEL_ZIP"
        
        echo "✅ GitHub 发布创建完成"
