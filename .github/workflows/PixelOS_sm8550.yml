name: OnePlus ACE3 Kernel Build (sukiSU+SUSFS+KPM)

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: '内核版本（适配一加ACE3）'
        required: true
        default: '5.15.196' # 一加ACE3适配的内核基线版本
      build_type:
        description: '编译类型 (release/debug)'
        required: true
        default: 'release'

jobs:
  build-kernel:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: 环境准备
        run: |
          sudo apt update -y
          sudo apt install -y \
            bc bison build-essential ccache curl flex g++-multilib gcc-multilib git \
            gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev \
            liblz4-tool libncurses5 libncurses5-dev libsdl1.2-dev libssl-dev libxml2 \
            libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip \
            zlib1g-dev openjdk-11-jdk python3 python3-pip libclang-dev clang \
            ninja-build pkg-config libglib2.0-dev libpixman-1-dev

          # 安装Android NDK（适配5.15内核）
          mkdir -p ~/android-ndk
          curl -L https://dl.google.com/android/repository/android-ndk-r25b-linux.zip -o ndk.zip
          unzip -q ndk.zip -d ~/android-ndk
          export ANDROID_NDK_HOME=~/android-ndk/android-ndk-r25b
          export PATH=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
          echo "PATH=$PATH" >> $GITHUB_ENV

          # 配置ccache加速
          mkdir -p ~/.ccache
          echo 'max_size = 50G' > ~/.ccache/ccache.conf

      - name: 拉取内核源码
        run: |
          # 替换为一加ACE3的内核源码仓库（建议使用适配版）
          git clone https://github.com/your-repo/oneplus-ace3-kernel.git kernel
          cd kernel
          # 检出适配版本（根据Numbersf代码调整）
          git checkout ace3-5.15-sukisu

      - name: 集成sukiSU/SUSFS/KPM
        run: |
          cd kernel
          # 1. 应用sukiSU补丁（来自Numbersf代码）
          patch -p1 < patches/sukisu/5.15/sukisu-core.patch
          patch -p1 < patches/sukisu/5.15/sukisu-ace3.patch

          # 2. 启用SUSFS配置
          cp configs/ace3_defconfig .config
          echo "CONFIG_SUSFS=y" >> .config
          echo "CONFIG_SUSFS_DEBUG=n" >> .config
          echo "CONFIG_SUSFS_PROC=y" >> .config

          # 3. 启用KPM（Kernel Patch Manager）
          echo "CONFIG_KPM=y" >> .config
          echo "CONFIG_KPM_CORE=y" >> .config
          echo "CONFIG_KPM_MODULES=y" >> .config

          # 4. 适配一加ACE3硬件配置
          cat configs/ace3-hardware.conf >> .config
          make olddefconfig

      - name: 编译内核
        run: |
          cd kernel
          # 设置编译参数
          export ARCH=arm64
          export SUBARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
          export CC=clang
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export LD=lld

          # 多核编译（根据Runner资源调整）
          make -j$(nproc) \
            O=out \
            ARCH=arm64 \
            CC=clang \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE=aarch64-linux-gnu- \
            ${{ github.event.inputs.build_type == 'debug' && 'CONFIG_DEBUG_KERNEL=y' || '' }}

      - name: 打包内核镜像
        run: |
          cd kernel/out/arch/arm64/boot
          # 生成boot.img（适配一加ACE3分区格式）
          mkbootimg \
            --kernel Image.gz-dtb \
            --ramdisk ../../../../ramdisk/ace3-ramdisk.cpio.gz \
            --dtb ../../../../dtbs/qcom/sm8475-oneplus-ace3.dtb \
            --cmdline "console=ttyMSM0,115200n8 androidboot.hardware=qcom androidboot.console=ttyMSM0 androidboot.memcg=1 lpm_levels.sleep_disabled=1 video=vfb:640x400,bpp=32,memsize=3072000 msm_rtb.filter=0x237 service_locator.enable=1 swiotlb=2048 androidboot.usbcontroller=a600000.dwc3 androidboot.boot_devices=soc/1d84000.ufshc" \
            --base 0x00000000 \
            --pagesize 4096 \
            --offset 0x00080000 \
            --dtb_offset 0x01f00000 \
            --tags_offset 0x00000100 \
            --os_version 13 \
            --os_patch_level 2024-01 \
            --header_version 1 \
            -o boot-ace3-sukisu.img

          # 压缩打包
          zip -r oneplus-ace3-kernel-sukisu-susfs-kpm-${{ github.event.inputs.kernel_version }}.zip boot-ace3-sukisu.img

      - name: 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: oneplus-ace3-kernel-build
          path: kernel/out/arch/arm64/boot/oneplus-ace3-kernel-sukisu-susfs-kpm-*.zip

      - name: 发布Release（可选）
        if: ${{ github.event.inputs.build_type == 'release' }}
        uses: softprops/action-gh-release@v1
        with:
          files: kernel/out/arch/arm64/boot/oneplus-ace3-kernel-sukisu-susfs-kpm-*.zip
          tag_name: ace3-kernel-${{ github.event.inputs.kernel_version }}-sukisu
          name: OnePlus ACE3 Kernel ${{ github.event.inputs.kernel_version }} (sukiSU+SUSFS+KPM)
          body: |
            适配一加ACE3的内核编译版本
            - 内核版本：${{ github.event.inputs.kernel_version }}
            - 特性：sukiSU + SUSFS + KPM
            - 编译类型：${{ github.event.inputs.build_type }}
