name: Build Aston Kernel (SukiSU + SUSFS + KPM + AK3)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 准备依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison lld llvm sed \
            libssl-dev libelf-dev libncurses-dev binutils-aarch64-linux-gnu curl git zip

      - name: 下载 AOSP Clang (r547379)
        run: |
          mkdir -p $GITHUB_WORKSPACE/toolchains
          git clone https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86 --depth=1 -b android16-release clang-android16-release

      - name: 获取源码与补丁
        run: |
          git clone https://github.com/OnePlus12R-development/android_kernel_oneplus_sm8550.git --depth=1 -b sixteen-qpr1 sm8550
          git clone https://github.com/OnePlus12R-development/android_kernel_oneplus_sm8550-modules.git --depth=1 -b sixteen-qpr1 sm8550-modules
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-android15-6.1

      - name: 集成 SukiSU-Ultra
        working-directory: sm8550
        run: |
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s master

      - name: 应用 SUSFS 补丁
        working-directory: sm8550
        run: |
          cp ../susfs4ksu/kernel_patches/50_add_susfs_in_gki-android15-6.1.patch ./
          cp ../susfs4ksu/kernel_patches/fs/* ./fs/
          cp ../susfs4ksu/kernel_patches/include/linux/* ./include/linux/
          patch -p1 < 50_add_susfs_in_gki-android15-6.1.patch || echo "Patch partially applied"

      - name: 注入内核配置 (KSU/SUSFS/KPM)
        working-directory: sm8550
        run: |
          CONF="arch/arm64/configs/vendor/kalama_GKI.config"
          echo "CONFIG_KSU=y" >> $CONF
          echo "CONFIG_KSU_SUSFS=y" >> $CONF
          echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> $CONF
          echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> $CONF
          echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> $CONF
          echo "CONFIG_KPM=y" >> $CONF

      - name: 执行内核编译
        working-directory: sm8550
        run: |
          CLANG_BIN="$GITHUB_WORKSPACE/toolchains/clang-android16-release/clang-r547379/bin"
          export PATH="${CLANG_BIN}:$PATH"
          export LLVM=1
          export LLVM_IAS=1
          export CC="${CLANG_BIN}/clang"
          export HOSTCC="${CLANG_BIN}/clang"
          export HOSTCXX="${CLANG_BIN}/clang++"
          export LD="${CLANG_BIN}/ld.lld"
          export AR="${CLANG_BIN}/llvm-ar"
          export NM="${CLANG_BIN}/llvm-nm"
          export OBJCOPY="${CLANG_BIN}/llvm-objcopy"
          export OBJDUMP="${CLANG_BIN}/llvm-objdump"
          export STRIP="${CLANG_BIN}/llvm-strip"
          
          make ARCH=arm64 O=out \
            CROSS_COMPILE=aarch64-linux-android- \
            CROSS_COMPILE_COMPAT=arm-linux-androideabi- \
            gki_defconfig vendor/kalama_GKI.config vendor/oplus/kalama_GKI.config vendor/debugfs.config

          make -j$(nproc) ARCH=arm64 O=out \
            CROSS_COMPILE=aarch64-linux-android- \
            CROSS_COMPILE_COMPAT=arm-linux-androideabi-

      - name: 准备 AnyKernel3 刷机包
        run: |
          git clone https://github.com/Numbersf/AnyKernel3 --depth=1
          rm -rf ./AnyKernel3/.git
          
          # 获取编译出的 Image
          RAW_IMAGE="sm8550/out/arch/arm64/boot/Image"
          
          # 执行 KPM patch_linux 修补
          curl -LO https://raw.githubusercontent.com/Numbersf/Action-Build/main/patches/patch_linux
          chmod +x patch_linux
          ./patch_linux "$RAW_IMAGE"
          
          # 将修补后的 oImage 放入 AK3 目录并重命名为 Image
          mv oImage ./AnyKernel3/Image

      - name: 打包刷机包
        working-directory: AnyKernel3
        run: |
          zip -r9 ../Aston-SukiSU-Ultra.zip * -x .git README.md

      - name: 上传刷机包
        uses: actions/upload-artifact@v4
        with:
          name: Aston-Kernel-AnyKernel3
          path: Aston-SukiSU-Ultra.zip
