name: PixelOS_Ultimate_GKI_V35

on:
  workflow_dispatch:
    inputs:
      enable_susfs:
        description: '启用 SUSFS'
        type: boolean
        default: true

jobs:
  Build_Kernel:
    name: Build GKI Kernel
    runs-on: ubuntu-latest
    
    steps:
      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'

      - name: Setup Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison binfmt-support libssl-dev libelf-dev \
          clang-15 lld-15 llvm-15 python3-pip git-lfs gawk dos2unix rsync libncurses-dev jq zip
          sudo ln -sf /usr/bin/clang-15 /usr/bin/clang
          sudo ln -sf /usr/bin/ld.lld-15 /usr/bin/ld.lld
          sudo ln -sf /usr/bin/llvm-nm-15 /usr/bin/llvm-nm

      - name: Clone Source
        run: |
          git clone https://github.com/OnePlus12R-development/android_kernel_oneplus_sm8550.git --depth=1 -b sixteen-qpr1 kernel

      - name: Get SUSFS & KPM
        run: |
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-android14-6.1 susfs_src
          mkdir -p kernel/drivers/kpm
          curl -LSs https://raw.githubusercontent.com/rifsxd/KPM/main/kpm/Kbuild -o kernel/drivers/kpm/Kbuild
          curl -LSs https://raw.githubusercontent.com/rifsxd/KPM/main/kpm/kpm.c -o kernel/drivers/kpm/kpm.c

      - name: Surgical Integration
        run: |
          cd kernel
          # 1. 物理移除 ABI 限制
          find . -name "BUILD.bazel" -exec sed -i '/"protected_exports_list"/d' {} +
          rm -f android/abi_gki_protected_exports_* 2>/dev/null || true
          # 2. 屏蔽 check_defconfig
          [ -f "./build.config.gki" ] && sed -i 's/check_defconfig//' ./build.config.gki || true
          # 3. 递归清理失效路径 (关键 Python 脚本)
          python3 -c '
          import os, re
          def clean(f):
              if not os.path.exists(f): return
              with open(f,"r") as r: lines = r.readlines()
              with open(f,"w") as w:
                  for l in lines:
                      m = re.search(r"source\s+\"([^\"]+)\"", l)
                      if m and not os.path.exists(os.path.join(os.path.dirname(f), m.group(1))): continue
                      w.write(l)
          for r, d, fs in os.walk("."):
              for f in fs:
                  if f in ["Kconfig", "Kbuild", "Makefile"]: clean(os.path.join(r, f))
          '
          # 4. 彻底禁用 Headers 安装 (解决 image_16cc2b.png 报错)
          sed -i 's/headers_install//g' Makefile
          sed -i 's/headers_check//g' Makefile
          # 5. 注入 SUSFS
          cp ../susfs_src/kernel_patches/fs/* ./fs/
          cp ../susfs_src/kernel_patches/include/linux/* ./include/linux/
          PATCH=$(find ../susfs_src/kernel_patches/ -name "*add_susfs_in_gki-android14-6.1.patch" | head -n 1)
          patch -p1 < "$PATCH" || echo "Skip patch conflict"
          echo "obj-y += kpm/" >> drivers/Makefile

      - name: Build Kernel
        run: |
          cd kernel
          GKI_CONF="arch/arm64/configs/gki_defconfig"
          sed -i 's/^CONFIG_LTO_CLANG_FULL=y/CONFIG_LTO_CLANG_THIN=y/' "$GKI_CONF"
          {
            echo "CONFIG_KSU=y"
            echo "CONFIG_KPM=y"
            echo "CONFIG_KSU_SUSFS=y"
            echo "CONFIG_KSU_SUSFS_SUS_PATH=y"
            echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y"
          } >> "$GKI_CONF"
          
          # 直接执行编译目标，绝不给 Makefile 运行 headers_install 的机会
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 CROSS_COMPILE=aarch64-linux-gnu- KCFLAGS="-Wno-error -fcommon" gki_defconfig
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 CROSS_COMPILE=aarch64-linux-gnu- KCFLAGS="-Wno-error -fcommon" -j$(nproc) Image
          
          # 手动压包
          gzip -c arch/arm64/boot/Image > arch/arm64/boot/Image.gz

      - name: Upload
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "GKI-V35-${{ github.run_id }}"
          name: "OnePlus 12R GKI Final V35"
          files: kernel/arch/arm64/boot/Image.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
