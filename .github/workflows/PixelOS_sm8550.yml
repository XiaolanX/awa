# 保留inferno0230原有的name和触发方式
name: OnePlus ACE3 Kernel Build

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/**'
      - 'kernel/**'

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      # 适配NDK r29：使用你指定的谷歌官方源链接
      - name: Setup Environment
        run: |
          sudo apt update -y
          sudo apt install -y --no-install-recommends \
            bc bison build-essential ccache curl flex g++-multilib gcc-multilib git \
            gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev \
            liblz4-tool libncurses5 libncurses5-dev libsdl1.2-dev libssl-dev libxml2 \
            libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip \
            zlib1g-dev openjdk-11-jdk python3 python3-pip libclang-dev clang \
            ninja-build pkg-config libglib2.0-dev libpixman-1-dev libelf-dev unzip wget

          # 使用你指定的NDK r29链接（谷歌官方源）
          NDK_URL="https://googledownloads.cn/android/repository/android-ndk-r29-linux.zip"
          NDK_DIR="$HOME/android-ndk"
          mkdir -p $NDK_DIR
          cd $NDK_DIR

          # 断点续传+5次重试+30秒超时，适配境外网络
          wget --tries=5 --timeout=30 --continue \
            "$NDK_URL" -O ndk.zip

          # 校验文件完整性
          if [ ! -s ndk.zip ]; then
            echo "Error: NDK zip file is empty or corrupted!"
            exit 1
          fi

          # 解压并配置环境变量（适配r29路径）
          unzip -q ndk.zip -d $NDK_DIR
          export ANDROID_NDK_HOME="$NDK_DIR/android-ndk-r29"
          export PATH="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
          echo "PATH=$PATH" >> $GITHUB_ENV

          # 验证r29工具链（关键：r29工具链命名兼容旧版）
          if ! command -v aarch64-linux-android-clang &> /dev/null; then
            echo "Error: NDK r29 toolchain not found!"
            ls -la $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/
            exit 1
          fi

      # 保留原代码的源码拉取逻辑
      - name: Clone Kernel Source
        run: |
          git clone --depth=1 https://github.com/inferno0230/oneplus-ace3-kernel.git kernel
          cd kernel
          git checkout main

      # 仅添加SUSFS+KPM支持（核心逻辑不变）
      - name: Enable SUSFS and KPM Support
        run: |
          cd kernel
          cp arch/arm64/configs/ace3_defconfig .config
          
          echo "CONFIG_SUSFS=y" >> .config
          echo "CONFIG_SUSFS_FS=y" >> .config
          echo "CONFIG_SUSFS_PROC=y" >> .config
          echo "CONFIG_SUSFS_SECURITY=y" >> .config
          echo "CONFIG_SUSFS_DEBUG=n" >> .config
          
          echo "CONFIG_KPM=y" >> .config
          echo "CONFIG_KPM_CORE=y" >> .config
          echo "CONFIG_KPM_MODULES=y" >> .config
          echo "CONFIG_KPM_COMPAT=y" >> .config
          
          make olddefconfig
          grep -E "CONFIG_SUSFS|CONFIG_KPM" .config

      # 适配NDK r29的编译逻辑（工具链命名完全兼容）
      - name: Build Kernel
        run: |
          cd kernel
          export ARCH=arm64
          export SUBARCH=arm64
          # NDK r29保持和旧版一致的工具链命名，无需额外修改
          export CROSS_COMPILE=aarch64-linux-android-
          export CROSS_COMPILE_ARM32=arm-linux-androideabi-
          export CC=clang
          export CLANG_TRIPLE=aarch64-linux-android-
          export LD=lld

          make -j$(nproc) \
            O=out \
            ARCH=arm64 \
            CC=clang \
            CLANG_TRIPLE=aarch64-linux-android- \
            CROSS_COMPILE=aarch64-linux-android-

      # 保留原代码的打包逻辑
      - name: Package Kernel
        run: |
          cd kernel/out/arch/arm64/boot
          mkbootimg \
            --kernel Image.gz-dtb \
            --ramdisk ../../../../ramdisk/ace3-ramdisk.cpio.gz \
            --dtb ../../../../dtbs/qcom/sm8475-oneplus-ace3.dtb \
            --cmdline "console=ttyMSM0,115200n8 androidboot.hardware=qcom androidboot.console=ttyMSM0 androidboot.memcg=1 lpm_levels.sleep_disabled=1 video=vfb:640x400,bpp=32,memsize=3072000 msm_rtb.filter=0x237 service_locator.enable=1 swiotlb=2048 androidboot.usbcontroller=a600000.dwc3 androidboot.boot_devices=soc/1d84000.ufshc" \
            --base 0x00000000 \
            --pagesize 4096 \
            --offset 0x00080000 \
            --dtb_offset 0x01f00000 \
            --tags_offset 0x00000100 \
            --os_version 13 \
            --os_patch_level 2024-01 \
            --header_version 1 \
            -o boot-ace3.img

          zip -r oneplus-ace3-kernel.zip boot-ace3.img

      # 使用v4版本上传产物
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: oneplus-ace3-kernel
          path: kernel/out/arch/arm64/boot/oneplus-ace3-kernel.zip

      # 保留原发布逻辑
      - name: Release
        uses: softprops/action-gh-release@v1
        if: github.ref == 'refs/heads/main'
        with:
          files: kernel/out/arch/arm64/boot/oneplus-ace3-kernel.zip
          tag_name: ace3-kernel-$(date +%Y%m%d)
          name: OnePlus ACE3 Kernel $(date +%Y%m%d)
          body: |
            OnePlus ACE3 Kernel Build
            - Added SUSFS and KPM support
            - Keep all original features
            - Use Android NDK r29
