name: PixelOS_Kernel_CI-aston

on:
  workflow_dispatch:
    inputs:
      enable_susfs:
        description: '启用 SUSFS 支持'
        type: boolean
        default: true
      enable_kpm:
        description: '启用 KPM (内核模块) 支持'
        type: boolean
        default: true
      susfs_branch:
        description: 'SUSFS 分支名称 (已知选项: master, kernel-4.14, 或其他)'
        type: string
        default: 'master'  # 关键修改1：默认分支改为 master
      kpm_repo:  # 关键修改2：将 kpm_config 改为可配置的仓库地址
        description: 'KPM 工具/补丁仓库地址 (示例: https://github.com/dynup/kpatch.git)'
        type: string
        default: 'https://github.com/dynup/kpatch.git'

jobs:
  PixelOS_Kernel_CI:
    name: PixelOS Kernel CI
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Clone Kernel and Dependencies
      run: |
        git clone https://github.com/OnePlus12R-development/android_kernel_oneplus_sm8550.git --depth=1 -b sixteen-qpr1 kernel/oneplus/sm8550
        git clone https://github.com/OnePlus12R-development/android_kernel_oneplus_sm8550-modules.git --depth=1 -b sixteen-qpr1 kernel/oneplus/sm8550-modules

    - name: Setup SUSFS Environment
      if: inputs.enable_susfs
      run: |
        echo "正在设置 SUSFS 环境..."
        # 关键修改3：增强分支克隆的容错能力
        if git clone https://gitlab.com/simonpunk/susfs4ksu.git -b ${{ inputs.susfs_branch }} susfs_patches; then
            echo "✅ 成功使用分支: ${{ inputs.susfs_branch }}"
        else
            echo "❌ 指定分支 ${{ inputs.susfs_branch }} 克隆失败，尝试默认的 master 分支"
            git clone https://gitlab.com/simonpunk/susfs4ksu.git -b master susfs_patches
        fi
        
        # 关键修改4：增加目录存在性检查，避免复制错误
        if [ -d "susfs_patches/kernel_patches" ]; then
            cp -r susfs_patches/kernel_patches/* kernel/oneplus/sm8550/
            echo "✅ SUSFS 补丁文件复制完成"
        else
            echo "❌ SUSFS 补丁目录不存在，请检查仓库结构"
            ls -la susfs_patches/
            exit 1  # 关键：目录不存在时主动报错退出
        fi

    - name: Setup KPM Environment  
      if: inputs.enable_kpm
      run: |
        echo "正在设置 KPM 环境..."
        # 关键修改5：修正KPM仓库地址，并克隆工具而非模板
        git clone ${{ inputs.kpm_repo }} kpm_tools --depth=1
        
        # 关键修改6：将KPM补丁工具复制到内核目录备用
        if [ -f "kpm_tools/patch_linux" ]; then
            cp kpm_tools/patch_linux kernel/oneplus/sm8550/
            chmod +x kernel/oneplus/sm8550/patch_linux
            echo "✅ KPM 补丁工具已设置"
        else
            echo "⚠️ 未在KPM工具库中找到标准 patch_linux 文件，将依赖内核内置支持"
        fi
        echo "KPM 环境设置完成"

    - name: Apply SUSFS Patches
      if: inputs.enable_susfs
      run: |
        cd kernel/oneplus/sm8550
        echo "应用 SUSFS 补丁..."
        
        # 关键修改7：更健壮的补丁应用逻辑
        for patch_file in $(find . -name "*.patch" | grep -i susfs); do
            if [ -f "$patch_file" ]; then
                echo "应用补丁: $(basename $patch_file)"
                if patch -p1 --dry-run < "$patch_file" &>/dev/null; then
                    patch -p1 < "$patch_file"
                    echo "✅ 补丁应用成功: $patch_file"
                else
                    echo "⚠️ 补丁可能已应用或存在冲突: $patch_file，尝试强制应用"
                    patch -p1 -f --no-backup-if-mismatch < "$patch_file" || echo "⚠️ 补丁应用遇到问题，但继续执行..."
                fi
            fi
        done
        echo "SUSFS 补丁应用完成"

    - name: Configure Kernel Options
      run: |
        cd kernel/oneplus/sm8550
        # 备份原始配置文件
        cp arch/arm64/configs/vendor/sm8550_defconfig arch/arm64/configs/vendor/sm8550_defconfig.backup
        
        # 基础配置
        echo "CONFIG_MODULES=y" >> arch/arm64/configs/vendor/sm8550_defconfig
        echo "CONFIG_MODULE_UNLOAD=y" >> arch/arm64/configs/vendor/sm8550_defconfig
        
        # 条件性添加 SUSFS 配置
        if [ "${{ inputs.enable_susfs }}" = "true" ]; then
            echo "CONFIG_KSU_SUSFS=y" >> arch/arm64/configs/vendor/sm8550_defconfig
            echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> arch/arm64/configs/vendor/sm8550_defconfig
            echo "CONFIG_KSU_SUSFS_SUS_MAP=y" >> arch/arm64/configs/vendor/sm8550_defconfig
            echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> arch/arm64/configs/vendor/sm8550_defconfig
            echo "✅ SUSFS 配置已添加"
        fi
        
        # 关键修改8：修正KPM配置项
        if [ "${{ inputs.enable_kpm }}" = "true" ]; then
            echo "CONFIG_KPROBES=y" >> arch/arm64/configs/vendor/sm8550_defconfig
            echo "CONFIG_HAVE_KPROBES=y" >> arch/arm64/configs/vendor/sm8550_defconfig
            echo "CONFIG_KPROBE_EVENTS=y" >> arch/arm64/configs/vendor/sm8550_defconfig
            # 如果是Live Patch类KPM，还需要以下配置
            echo "CONFIG_LIVEPATCH=y" >> arch/arm64/configs/vendor/sm8550_defconfig
            echo "✅ KPM 配置已添加"
        fi
        
        echo "内核配置更新完成"

    # 关键修改9：在构建步骤中添加KPM补丁应用
    - name: Build Kernel with ksu
      run: |
        cd kernel/oneplus/sm8550
        # 先构建基础内核
        build_sm8550 --clean --ksu
        
        # 条件性应用KPM补丁
        if [ "${{ inputs.enable_kpm }}" = "true" ] && [ -f "patch_linux" ]; then
            echo "应用 KPM 补丁..."
            chmod +x patch_linux
            ./patch_linux
            # 检查补丁是否生成了新镜像
            if [ -f "oImage" ]; then
                mv oImage kernel_ksu
                echo "✅ KPM 补丁应用成功"
            fi
        fi
        
        mv kernel.zip ${GITHUB_WORKSPACE}/ksu${{ inputs.enable_susfs && '_susfs' || '' }}${{ inputs.enable_kpm && '_kpm' || '' }}.zip
        git clean -fdx && find . -mindepth 1 -maxdepth 1 -type d -exec test -d "{}/.git" \; -print | xargs rm -rf && git reset --hard
        cd -

    # 为 ksu-next 和 sukisu 构建任务添加相同的KPM补丁逻辑
    - name: Build Kernel with ksu-next
      run: |
        cd kernel/oneplus/sm8550
        build_sm8550 --clean --ksu-next
        
        if [ "${{ inputs.enable_kpm }}" = "true" ] && [ -f "patch_linux" ]; then
            echo "应用 KPM 补丁..."
            chmod +x patch_linux
            ./patch_linux
            if [ -f "oImage" ]; then
                mv oImage kernel_ksu_next
                echo "✅ KPM 补丁应用成功"
            fi
        fi
        
        mv kernel.zip ${GITHUB_WORKSPACE}/ksu-next${{ inputs.enable_susfs && '_susfs' || '' }}${{ inputs.enable_kpm && '_kpm' || '' }}.zip
        git clean -fdx && find . -mindepth 1 -maxdepth 1 -type d -exec test -d "{}/.git" \; -print | xargs rm -rf && git reset --hard
        cd -

    - name: Build Kernel with sukisu
      run: |
        cd kernel/oneplus/sm8550
        build_sm8550 --clean --sukisu
        
        if [ "${{ inputs.enable_kpm }}" = "true" ] && [ -f "patch_linux" ]; then
            echo "应用 KPM 补丁..."
            chmod +x patch_linux
            ./patch_linux
            if [ -f "oImage" ]; then
                mv oImage kernel_sukisu
                echo "✅ KPM 补丁应用成功"
            fi
        fi
        
        mv kernel.zip ${GITHUB_WORKSPACE}/sukisu${{ inputs.enable_susfs && '_susfs' || '' }}${{ inputs.enable_kpm && '_kpm' || '' }}.zip
        git clean -fdx && find . -mindepth 1 -maxdepth 1 -type d -exec test -d "{}/.git" \; -print | xargs rm -rf && git reset --hard
        cd -

    - name: Create GitHub Release
      run: |
        cd ${GITHUB_WORKSPACE}
        RELEASE_FILES=$(ls *.zip | tr '\n' ' ')
        echo "发布文件: $RELEASE_FILES"
        
        # 关键修改10：增强发布说明信息
        RELEASE_NOTES="构建完成于 $(date)
特性支持:
- SUSFS: ${{ inputs.enable_susfs }} ${{ inputs.enable_susfs && format('(分支: {0}', inputs.susfs_branch) || '' }}
- KPM: ${{ inputs.enable_kpm }} ${{ inputs.enable_kpm && format('(仓库: {0})', inputs.kpm_repo) || '' }}"
        
        gh release create "$REL_NAME" --title "$REL_NAME" --notes "$RELEASE_NOTES" $RELEASE_FILES
