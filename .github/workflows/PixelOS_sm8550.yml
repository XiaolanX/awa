# 保留inferno0230原有的name和触发方式
name: OnePlus ACE3 Kernel Build

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/**'
      - 'kernel/**'

jobs:
  build:
    runs-on: ubuntu-22.04 # 保留原代码的系统版本
    permissions:
      contents: write

    steps:
      # 保留原代码的所有环境准备步骤，仅补充SUSFS/KPM编译依赖
      - name: Setup Environment
        run: |
          sudo apt update -y
          sudo apt full-upgrade -y
          # 保留原代码的所有依赖，仅新增KPM/SUSFS编译所需的libelf-dev
          sudo apt install -y \
            bc bison build-essential ccache curl flex g++-multilib gcc-multilib git \
            gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev \
            liblz4-tool libncurses5 libncurses5-dev libsdl1.2-dev libssl-dev libxml2 \
            libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip \
            zlib1g-dev openjdk-11-jdk python3 python3-pip libclang-dev clang \
            ninja-build pkg-config libglib2.0-dev libpixman-1-dev libelf-dev # 新增libelf-dev

          # 保留原代码的NDK配置（不改动版本和路径）
          mkdir -p ~/android-ndk
          curl -L https://dl.google.com/android/repository/android-ndk-r24b-linux.zip -o ndk.zip
          unzip -q ndk.zip -d ~/android-ndk
          export ANDROID_NDK_HOME=~/android-ndk/android-ndk-r24b
          export PATH=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
          echo "PATH=$PATH" >> $GITHUB_ENV

      # 保留原代码的源码拉取逻辑（不改动仓库和分支）
      - name: Clone Kernel Source
        run: |
          git clone --depth=1 https://github.com/inferno0230/oneplus-ace3-kernel.git kernel
          cd kernel
          git checkout main

      # 核心增量修改：仅添加SUSFS+KPM支持（不改动原有配置）
      - name: Enable SUSFS and KPM Support
        run: |
          cd kernel
          # 1. 保留原defconfig，仅追加SUSFS和KPM配置
          cp arch/arm64/configs/ace3_defconfig .config
          
          # 启用SUSFS核心配置（参考Numbersf的配置项）
          echo "CONFIG_SUSFS=y" >> .config
          echo "CONFIG_SUSFS_FS=y" >> .config
          echo "CONFIG_SUSFS_PROC=y" >> .config
          echo "CONFIG_SUSFS_SECURITY=y" >> .config
          echo "CONFIG_SUSFS_DEBUG=n" >> .config # 关闭调试避免兼容性问题
          
          # 启用KPM核心配置（参考Numbersf的配置项）
          echo "CONFIG_KPM=y" >> .config
          echo "CONFIG_KPM_CORE=y" >> .config
          echo "CONFIG_KPM_MODULES=y" >> .config
          echo "CONFIG_KPM_COMPAT=y" >> .config # 兼容原有内核逻辑
          
          # 生成最终配置，不改动原有配置项
          make olddefconfig
          # 验证配置是否生效（可选，便于排查问题）
          grep -E "CONFIG_SUSFS|CONFIG_KPM" .config

      # 保留原代码的编译逻辑（不改动编译参数、核心数、工具链）
      - name: Build Kernel
        run: |
          cd kernel
          export ARCH=arm64
          export SUBARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_ARM32=arm-linux-gnu-
          export CC=clang
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export LD=lld

          make -j$(nproc) \
            O=out \
            ARCH=arm64 \
            CC=clang \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE=aarch64-linux-gnu-

      # 保留原代码的打包逻辑（不改动boot.img参数、打包格式）
      - name: Package Kernel
        run: |
          cd kernel/out/arch/arm64/boot
          # 保留原代码的mkbootimg参数（确保刷入正常）
          mkbootimg \
            --kernel Image.gz-dtb \
            --ramdisk ../../../../ramdisk/ace3-ramdisk.cpio.gz \
            --dtb ../../../../dtbs/qcom/sm8475-oneplus-ace3.dtb \
            --cmdline "console=ttyMSM0,115200n8 androidboot.hardware=qcom androidboot.console=ttyMSM0 androidboot.memcg=1 lpm_levels.sleep_disabled=1 video=vfb:640x400,bpp=32,memsize=3072000 msm_rtb.filter=0x237 service_locator.enable=1 swiotlb=2048 androidboot.usbcontroller=a600000.dwc3 androidboot.boot_devices=soc/1d84000.ufshc" \
            --base 0x00000000 \
            --pagesize 4096 \
            --offset 0x00080000 \
            --dtb_offset 0x01f00000 \
            --tags_offset 0x00000100 \
            --os_version 13 \
            --os_patch_level 2024-01 \
            --header_version 1 \
            -o boot-ace3.img

          zip -r oneplus-ace3-kernel.zip boot-ace3.img

      # 保留原代码的产物上传逻辑
      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: oneplus-ace3-kernel
          path: kernel/out/arch/arm64/boot/oneplus-ace3-kernel.zip

      # 保留原代码的Release发布逻辑（如有）
      - name: Release
        uses: softprops/action-gh-release@v1
        if: github.ref == 'refs/heads/main'
        with:
          files: kernel/out/arch/arm64/boot/oneplus-ace3-kernel.zip
          tag_name: ace3-kernel-$(date +%Y%m%d)
          name: OnePlus ACE3 Kernel $(date +%Y%m%d)
          body: |
            OnePlus ACE3 Kernel Build
            - Added SUSFS and KPM support
            - Keep all original features
