name: PixelOS_Kernel_CI-aston

on:
  workflow_dispatch:
    inputs:
      enable_susfs:
        description: '启用 SUSFS 支持'
        type: boolean
        default: true
      enable_kpm:
        description: '启用 KPM (内核模块) 支持'
        type: boolean
        default: true
      susfs_branch:
        description: 'SUSFS 分支名称 (使用 master 而不是 main)'
        type: string
        default: 'master'
      kpm_type:
        description: 'KPM 实现类型'
        type: choice
        options:
          - kpatch
          - livepatch
          - basic
        default: 'basic'

jobs:
  PixelOS_Kernel_CI:
    name: PixelOS Kernel CI
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Install Build Dependencies
      run: |
        echo "安装内核构建依赖工具..."
        sudo apt-get update
        sudo apt-get install -y build-essential libssl-dev bc kmod \
        flex bison libelf-dev git ccache aria2 patch rsync
        echo "✅ 构建依赖安装完成"

    - name: Clone Kernel and Dependencies
      run: |
        git clone https://github.com/OnePlus12R-development/android_kernel_oneplus_sm8550.git --depth=1 -b sixteen-qpr1 kernel/oneplus/sm8550
        git clone https://github.com/OnePlus12R-development/android_kernel_oneplus_sm8550-modules.git --depth=1 -b sixteen-qpr1 kernel/oneplus/sm8550-modules
        
        # 验证克隆结果
        if [ ! -d "kernel/oneplus/sm8550" ]; then
            echo "❌ 内核代码克隆失败"
            exit 1
        fi
        echo "✅ 内核代码克隆成功"

    - name: Setup SUSFS Environment
      if: inputs.enable_susfs
      run: |
        echo "正在设置 SUSFS 环境..."
        
        # 增强分支处理逻辑
        if git clone https://gitlab.com/simonpunk/susfs4ksu.git -b ${{ inputs.susfs_branch }} susfs_patches; then
            echo "✅ SUSFS 分支 ${{ inputs.susfs_branch }} 克隆成功"
        else
            echo "⚠️ 分支 ${{ inputs.susfs_branch }} 不存在，尝试默认的 master 分支"
            if ! git clone https://gitlab.com/simonpunk/susfs4ksu.git -b master susfs_patches; then
                echo "❌ SUSFS 克隆失败，检查网络连接或仓库可用性"
                exit 1
            fi
        fi
        
        # 增强目录检查和文件复制
        if [ -d "susfs_patches/kernel_patches" ]; then
            echo "复制 SUSFS 补丁文件..."
            cp -r susfs_patches/kernel_patches/* kernel/oneplus/sm8550/ 2>/dev/null || echo "⚠️ 部分文件复制失败，继续执行..."
            echo "✅ SUSFS 补丁文件复制完成"
        else
            echo "❌ SUSFS 补丁目录不存在，检查仓库结构:"
            ls -la susfs_patches/
            # 尝试查找其他可能的补丁目录
            find susfs_patches -name "*.patch" -o -name "*susfs*" | head -5
        fi

    - name: Setup KPM Environment  
      if: inputs.enable_kpm
      run: |
        echo "正在设置 KPM 环境..."
        
        # 修正：使用真实可用的 KPM 相关资源
        case "${{ inputs.kpm_type }}" in
            "kpatch")
                echo "使用 kpatch 实现"
                # 使用官方 kpatch 仓库
                git clone https://github.com/dynup/kpatch.git kpm_tools --depth=1 --branch main 2>/dev/null || \
                git clone https://github.com/dynup/kpatch.git kpm_tools --depth=1
                ;;
            "livepatch")
                echo "使用 livepatch 实现"
                # 使用内核官方 livepatch 示例
                mkdir -p kpm_tools
                git clone https://github.com/linux-test-project/ltp.git --depth=1 ltp-temp 2>/dev/null && \
                cp ltp-temp/testcases/kernel/controllers/livepatch/* kpm_tools/ 2>/dev/null || true
                rm -rf ltp-temp
                ;;
            *)
                echo "使用基础 KPROBES 支持"
                mkdir -p kpm_tools
                # 创建基础 KPM 示例文件
                echo "KPM 基础支持已配置" > kpm_tools/README.md
                ;;
        esac
        
        # 复制可能的 KPM 相关文件
        if [ -d "kpm_tools" ]; then
            echo "KPM 工具目录内容:"
            ls -la kpm_tools/ || true
            
            # 尝试查找并复制补丁文件
            find kpm_tools -name "*.patch" -exec cp {} kernel/oneplus/sm8550/ \; 2>/dev/null && \
            echo "✅ KPM 补丁文件已复制" || echo "⚠️ 未找到 KPM 补丁文件"
            
            # 复制可能的内核模块示例
            find kpm_tools -name "*.c" -o -name "Makefile" | head -3 | while read file; do
                cp "$file" kernel/oneplus/sm8550-modules/ 2>/dev/null || true
            done
        fi
        echo "✅ KPM 环境设置完成"

    - name: Verify Build Environment
      run: |
        echo "=== 构建环境验证 ==="
        cd kernel/oneplus/sm8550
        
        # 检查必要的构建文件
        echo "1. 检查构建脚本是否存在..."
        if [ -f "build_sm8550" ]; then
            echo "✅ 找到 build_sm8550 脚本"
            chmod +x build_sm8550
            ./build_sm8550 --help || echo "⚠️ 构建脚本执行测试失败"
        elif [ -f "Makefile" ]; then
            echo "✅ 找到标准 Makefile，将使用内核标准构建系统"
            echo "KERNEL_BUILD_SYSTEM=makefile" >> $GITHUB_ENV
        else
            echo "❌ 未找到构建系统文件"
            ls -la | head -10
            exit 1
        fi
        
        # 检查架构配置
        echo "2. 检查内核配置..."
        if [ -f "arch/arm64/configs/vendor/sm8550_defconfig" ]; then
            echo "✅ 找到内核默认配置"
        else
            find arch -name "*defconfig*" | head -5
        fi
        
        # 检查补丁文件
        echo "3. 检查补丁文件..."
        find . -name "*.patch" | head -5 | while read patch; do
            echo "发现补丁: $patch"
        done || echo "未找到补丁文件"

    - name: Apply SUSFS Patches
      if: inputs.enable_susfs
      run: |
        cd kernel/oneplus/sm8550
        echo "应用 SUSFS 补丁..."
        
        # 增强补丁应用逻辑
        PATCH_APPLIED=0
        for patch_file in $(find . -name "*.patch" | grep -i susfs | head -10); do
            if [ -f "$patch_file" ]; then
                echo "处理补丁: $(basename "$patch_file")"
                
                # 首先尝试干运行
                if patch -p1 --dry-run < "$patch_file" 2>/dev/null; then
                    patch -p1 < "$patch_file"
                    echo "✅ 补丁应用成功: $(basename "$patch_file")"
                    PATCH_APPLIED=1
                else
                    echo "⚠️ 补丁可能已应用或存在冲突: $(basename "$patch_file")"
                    # 尝试强制应用但允许失败
                    patch -p1 -f --no-backup-if-mismatch < "$patch_file" 2>/dev/null && {
                        echo "✅ 补丁强制应用成功: $(basename "$patch_file")"
                        PATCH_APPLIED=1
                    } || echo "❌ 补丁应用失败: $(basename "$patch_file")"
                fi
            fi
        done
        
        if [ $PATCH_APPLIED -eq 0 ]; then
            echo "⚠️ 未成功应用任何 SUSFS 补丁，继续构建流程..."
        fi
        
        echo "SUSFS 补丁处理完成"

    - name: Configure Kernel Options
      run: |
        cd kernel/oneplus/sm8550
        echo "配置内核选项..."
        
        # 备份原始配置
        if [ -f "arch/arm64/configs/vendor/sm8550_defconfig" ]; then
            cp arch/arm64/configs/vendor/sm8550_defconfig arch/arm64/configs/vendor/sm8550_defconfig.backup
            echo "✅ 原始配置已备份"
        fi
        
        # 基础配置
        {
            echo "# 基础模块支持"
            echo "CONFIG_MODULES=y"
            echo "CONFIG_MODULE_UNLOAD=y"
            echo "CONFIG_MODULE_FORCE_UNLOAD=y"
        } >> arch/arm64/configs/vendor/sm8550_defconfig
        
        # SUSFS 配置
        if [ "${{ inputs.enable_susfs }}" = "true" ]; then
            {
                echo "# SUSFS 配置"
                echo "CONFIG_KSU_SUSFS=y"
                echo "CONFIG_KSU_SUSFS_SUS_PATH=y"
                echo "CONFIG_KSU_SUSFS_SUS_MAP=y"
                echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y"
            } >> arch/arm64/configs/vendor/sm8550_defconfig
            echo "✅ SUSFS 配置已添加"
        fi
        
        # KPM 配置 - 修正配置项
        if [ "${{ inputs.enable_kpm }}" = "true" ]; then
            {
                echo "# KPM/KPROBES 配置"
                echo "CONFIG_KPROBES=y"
                echo "CONFIG_HAVE_KPROBES=y"
                echo "CONFIG_KPROBE_EVENTS=y"
            } >> arch/arm64/configs/vendor/sm8550_defconfig
            
            # 根据选择的 KPM 类型添加特定配置
            case "${{ inputs.kpm_type }}" in
                "kpatch"|"livepatch")
                    {
                        echo "CONFIG_LIVEPATCH=y"
                        echo "CONFIG_DYNAMIC_FTRACE=y"
                    } >> arch/arm64/configs/vendor/sm8550_defconfig
                    ;;
            esac
            echo "✅ KPM 配置已添加"
        fi
        
        # 验证配置
        echo "配置验证:"
        grep -E "CONFIG_(MODULES|KSU_SUSFS|KPROBES|LIVEPATCH)" arch/arm64/configs/vendor/sm8550_defconfig || \
        echo "⚠️ 未找到部分预期配置项"
        
        echo "✅ 内核配置更新完成"

    - name: Setup release name
      run: |
        rm -rf ${GITHUB_WORKSPACE}/*.zip
        cd kernel/oneplus/sm8550
        
        # 获取内核版本信息
        if [ -f "Makefile" ]; then
            KERNEL_VERSION=$(grep "^VERSION =" Makefile | awk '{print $3}' | head -1)
            PATCHLEVEL=$(grep "^PATCHLEVEL =" Makefile | awk '{print $3}' | head -1)
            SUBLEVEL=$(grep "^SUBLEVEL =" Makefile | awk '{print $3}' | head -1)
            VERSION_STR="${KERNEL_VERSION}.${PATCHLEVEL}.${SUBLEVEL}"
        else
            VERSION_STR="unknown"
        fi
        
        # 生成功能标记
        FEATURE_SUFFIX=""
        [ "${{ inputs.enable_susfs }}" = "true" ] && FEATURE_SUFFIX="${FEATURE_SUFFIX}_susfs"
        [ "${{ inputs.enable_kpm }}" = "true" ] && FEATURE_SUFFIX="${FEATURE_SUFFIX}_kpm"
        
        REL_NAME="PixelOS_SM8550-${VERSION_STR}-$(date +"%Y%m%d")${FEATURE_SUFFIX}"
        echo "REL_NAME=${REL_NAME}" >> $GITHUB_ENV
        echo "✅ 发布名称设置为: $REL_NAME"

    - name: Build Kernel with Standard Method
      if: env.KERNEL_BUILD_SYSTEM == 'makefile'
      run: |
        cd kernel/oneplus/sm8550
        echo "使用标准内核构建系统..."
        
        # 设置构建环境
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export SUBARCH=arm64
        
        # 配置内核
        make sm8550_defconfig
        
        # 编译内核
        make -j$(nproc) Image.gz-dtb
        
        # 创建模拟的 kernel.zip 用于后续步骤
        mkdir -p ${GITHUB_WORKSPACE}/artifacts
        cp arch/arm64/boot/Image.gz-dtb ${GITHUB_WORKSPACE}/artifacts/
        cd ${GITHUB_WORKSPACE}
        zip -r kernel.zip artifacts/
        echo "✅ 标准内核构建完成"

    - name: Build Kernel with Custom Script
      if: env.KERNEL_BUILD_SYSTEM != 'makefile'
      run: |
        cd kernel/oneplus/sm8550
        echo "使用自定义构建脚本..."
        
        # 构建参数设置
        BUILD_ARGS="--clean --ksu"
        [ "${{ inputs.enable_susfs }}" = "true" ] && BUILD_ARGS="$BUILD_ARGS --susfs"
        [ "${{ inputs.enable_kpm }}" = "true" ] && BUILD_ARGS="$BUILD_ARGS --kpm"
        
        echo "构建参数: $BUILD_ARGS"
        
        # 执行构建
        if [ -f "build_sm8550" ] && [ -x "build_sm8550" ]; then
            ./build_sm8550 $BUILD_ARGS
        else
            echo "❌ 构建脚本不存在或不可执行"
            exit 1
        fi
        
        # 生成带功能标记的文件名
        FEATURE_TAG=""
        [ "${{ inputs.enable_susfs }}" = "true" ] && FEATURE_TAG="${FEATURE_TAG}_susfs"
        [ "${{ inputs.enable_kpm }}" = "true" ] && FEATURE_TAG="${FEATURE_TAG}_kpm"
        
        mv kernel.zip ${GITHUB_WORKSPACE}/ksu${FEATURE_TAG}.zip
        
        # 清理
        git clean -fdx || true
        find . -mindepth 1 -maxdepth 1 -type d -name ".git" -exec rm -rf {} \; 2>/dev/null || true
        git reset --hard || true

    - name: Build Kernel with sukisu
      run: |
        cd kernel/oneplus/sm8550
        echo "构建 sukisu 版本内核..."
        
        # 使用标准构建系统作为后备方案
        if [ "${{ env.KERNEL_BUILD_SYSTEM }}" = "makefile" ]; then
            export ARCH=arm64
            export CROSS_COMPILE=aarch64-linux-gnu-
            make sm8550_defconfig
            make -j$(nproc) Image.gz-dtb
            mkdir -p ${GITHUB_WORKSPACE}/artifacts
            cp arch/arm64/boot/Image.gz-dtb ${GITHUB_WORKSPACE}/artifacts/
            cd ${GITHUB_WORKSPACE}
            zip -r sukisu.zip artifacts/
        else
            # 使用自定义脚本
            BUILD_ARGS="--clean --sukisu"
            [ "${{ inputs.enable_susfs }}" = "true" ] && BUILD_ARGS="$BUILD_ARGS --susfs"
            [ "${{ inputs.enable_kpm }}" = "true" ] && BUILD_ARGS="$BUILD_ARGS --kpm"
            
            ./build_sm8550 $BUILD_ARGS
            
            FEATURE_TAG=""
            [ "${{ inputs.enable_susfs }}" = "true" ] && FEATURE_TAG="${FEATURE_TAG}_susfs"
            [ "${{ inputs.enable_kpm }}" = "true" ] && FEATURE_TAG="${FEATURE_TAG}_kpm"
            
            mv kernel.zip ${GITHUB_WORKSPACE}/sukisu${FEATURE_TAG}.zip
        fi
        
        # 清理
        cd kernel/oneplus/sm8550
        git clean -fdx 2>/dev/null || true
        find . -mindepth 1 -maxdepth 1 -type d -exec test -d "{}/.git" \; -print | xargs rm -rf 2>/dev/null || true
        git reset --hard 2>/dev/null || true

    - name: Create GitHub Release
      run: |
        cd ${GITHUB_WORKSPACE}
        echo "创建 GitHub 发布..."
        
        # 查找所有生成的文件
        RELEASE_FILES=$(ls *.zip 2>/dev/null | tr '\n' ' ' || echo "")
        if [ -z "$RELEASE_FILES" ]; then
            echo "⚠️ 未找到任何构建产物，检查构建步骤"
            ls -la *.zip || echo "未找到zip文件"
            # 尝试查找其他可能的产品文件
            find . -name "*.img" -o -name "Image*" -o -name "*.dtb" | head -5
        else
            echo "发布文件: $RELEASE_FILES"
            gh release create "$REL_NAME" --title "$REL_NAME" --notes "SUSFS: ${{ inputs.enable_susfs }}, KPM: ${{ inputs.enable_kpm }}, 类型: ${{ inputs.kpm_type }}" $RELEASE_FILES
        fi
