name: PixelOS Kernel CI

on:
  workflow_dispatch:
    inputs:
      enable_susfs:
        description: '启用 SUSFS 支持'
        type: boolean
        default: true
      enable_kpm:
        description: '启用 KPM 支持'
        type: boolean
        default: true
      susfs_branch:
        description: 'SUSFS 分支名称'
        type: string
        default: 'master'

jobs:
  build_kernel:
    name: Build PixelOS Kernel
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Install Dependencies
      run: |
        echo "安装编译依赖..."
        sudo apt-get update
        sudo apt-get install -y \
            build-essential libssl-dev bc kmod \
            flex bison libelf-dev git ccache patch rsync \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            binutils-aarch64-linux-gnu libncurses-dev \
            python3 python3-pip cpio lz4 device-tree-compiler
        echo "依赖安装完成"

    - name: Clone Kernel Source
      run: |
        echo "克隆内核源码..."
        git clone https://github.com/OnePlus12R-development/android_kernel_oneplus_sm8550.git \
            --depth=1 -b sixteen-qpr1 kernel/oneplus/sm8550
        
        if [ ! -d "kernel/oneplus/sm8550" ]; then
            echo "❌ 内核源码克隆失败"
            exit 1
        fi
        echo "✅ 内核源码克隆成功"

    - name: Explore Kernel Structure
      run: |
        echo "检查内核目录结构..."
        cd kernel/oneplus/sm8550
        echo "当前目录: $(pwd)"
        echo "文件列表:"
        ls -la
        echo "检查config目录:"
        find arch/arm64/configs -name "*defconfig*" 2>/dev/null | head -10
        echo "检查Makefile:"
        grep -E "VERSION|PATCHLEVEL|SUBLEVEL" Makefile 2>/dev/null || echo "未找到版本信息"

    - name: Find Config File
      id: find_config
      run: |
        cd kernel/oneplus/sm8550
        
        # 查找所有可能的defconfig文件
        CONFIG_FILES=$(find arch/arm64/configs -name "*defconfig*" 2>/dev/null)
        
        if [ -z "$CONFIG_FILES" ]; then
            echo "❌ 未找到任何defconfig文件"
            exit 1
        fi
        
        echo "找到的配置文件:"
        echo "$CONFIG_FILES"
        
        # 尝试常见的配置文件名
        CONFIG_CHOICES=(
            "vendor/sm8550_defconfig"
            "sm8550_defconfig" 
            "vendor/sm8550-perf_defconfig"
            "vendor/oneplus/sm8550_defconfig"
            "qgki_defconfig"
        )
        
        TARGET_CONFIG=""
        for config in "${CONFIG_CHOICES[@]}"; do
            if [ -f "arch/arm64/configs/$config" ]; then
                TARGET_CONFIG="$config"
                echo "✅ 找到配置文件: $TARGET_CONFIG"
                break
            fi
        done
        
        if [ -z "$TARGET_CONFIG" ]; then
            # 使用第一个找到的配置文件
            TARGET_CONFIG=$(echo "$CONFIG_FILES" | head -1 | sed 's|^arch/arm64/configs/||')
            echo "⚠️ 使用找到的第一个配置: $TARGET_CONFIG"
        fi
        
        echo "target_config=$TARGET_CONFIG" >> $GITHUB_OUTPUT
        echo "配置文件: $TARGET_CONFIG"

    - name: Setup SUSFS
      if: inputs.enable_susfs
      run: |
        echo "设置SUSFS..."
        
        if git clone https://gitlab.com/simonpunk/susfs4ksu.git \
            -b ${{ inputs.susfs_branch }} susfs_patches 2>/dev/null; then
            echo "✅ SUSFS仓库克隆成功"
            
            if [ -d "susfs_patches/kernel_patches" ]; then
                echo "复制SUSFS补丁..."
                find susfs_patches/kernel_patches -name "*.patch" 2>/dev/null | head -5
            else
                echo "⚠️ 未找到SUSFS补丁目录"
            fi
        else
            echo "⚠️ SUSFS克隆失败，跳过SUSFS"
        fi

    - name: Setup Build Environment
      run: |
        echo "设置构建环境..."
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        # 验证编译器
        echo "验证交叉编译器:"
        ${CROSS_COMPILE}gcc --version || echo "❌ 编译器不可用"
        
        # 设置环境变量供后续步骤使用
        echo "ARCH=$ARCH" >> $GITHUB_ENV
        echo "CROSS_COMPILE=$CROSS_COMPILE" >> $GITHUB_ENV
        echo "CONFIG_FILE=${{ steps.find_config.outputs.target_config }}" >> $GITHUB_ENV

    - name: Configure Kernel
      run: |
        cd kernel/oneplus/sm8550
        
        echo "配置内核..."
        echo "使用配置文件: $CONFIG_FILE"
        
        # 清理之前的构建
        make ARCH=$ARCH CROSS_COMPILE=$CROSS_COMPILE mrproper 2>/dev/null || echo "清理完成"
        
        # 应用默认配置
        make ARCH=$ARCH CROSS_COMPILE=$CROSS_COMPILE $CONFIG_FILE
        
        # 修改配置选项
        if [ "${{ inputs.enable_kpm }}" = "true" ]; then
            echo "启用KPM支持..."
            scripts/config --enable KPROBES
            scripts/config --enable HAVE_KPROBES
            scripts/config --enable KPROBE_EVENTS
        fi
        
        # 启用模块支持
        scripts/config --enable MODULES
        scripts/config --enable MODULE_UNLOAD
        
        # 生成最终配置
        make ARCH=$ARCH CROSS_COMPILE=$CROSS_COMPILE olddefconfig
        
        echo "配置完成"

    - name: Build Kernel
      run: |
        cd kernel/oneplus/sm8550
        
        echo "开始编译内核..."
        
        # 显示配置摘要
        echo "配置摘要:"
        grep -E "CONFIG_(MODULES|KPROBES)" .config 2>/dev/null || echo "未找到相关配置"
        
        # 获取CPU核心数用于并行编译
        CORE_COUNT=$(nproc)
        echo "使用 $CORE_COUNT 个核心进行编译"
        
        # 编译内核镜像
        make ARCH=$ARCH CROSS_COMPILE=$CROSS_COMPILE -j$CORE_COUNT Image.gz-dtb
        
        # 验证构建结果
        if [ -f "arch/arm64/boot/Image.gz-dtb" ]; then
            echo "✅ 内核编译成功"
            ls -lh arch/arm64/boot/Image.gz-dtb
        else
            echo "❌ 内核编译失败"
            echo "查找可能的输出文件:"
            find arch/arm64/boot -type f 2>/dev/null
            exit 1
        fi

    - name: Create Package
      run: |
        echo "创建内核包..."
        
        # 创建工作目录
        PKG_DIR="${GITHUB_WORKSPACE}/kernel_package"
        mkdir -p "$PKG_DIR"
        
        # 复制内核镜像
        cp kernel/oneplus/sm8550/arch/arm64/boot/Image.gz-dtb "$PKG_DIR/"
        
        # 创建简单的刷机脚本
        cat > "$PKG_DIR/flash.sh" << 'EOF'
        #!/bin/bash
        
        echo "PixelOS Kernel 刷机脚本"
        echo "设备: OnePlus 12R (SM8550)"
        echo "构建时间: $(date)"
        echo ""
        
        if [ ! -f "Image.gz-dtb" ]; then
            echo "错误: 未找到内核镜像"
            exit 1
        fi
        
        echo "请手动将 Image.gz-dtb 刷入设备"
        echo "建议使用以下命令:"
        echo "  fastboot flash boot Image.gz-dtb"
        EOF
        
        chmod +x "$PKG_DIR/flash.sh"
        
        # 创建版本信息
        cat > "$PKG_DIR/version.txt" << EOF
        PixelOS Kernel for OnePlus 12R
        设备: SM8550
        构建时间: $(date)
        特性: SUSFS=${{ inputs.enable_susfs }}, KPM=${{ inputs.enable_kpm }}
        配置文件: $CONFIG_FILE
        架构: $ARCH
        编译器: $CROSS_COMPILE
        EOF

    - name: Create ZIP Archive
      run: |
        echo "创建ZIP压缩包..."
        
        PKG_DIR="${GITHUB_WORKSPACE}/kernel_package"
        cd "$PKG_DIR"
        
        # 生成版本号
        KERNEL_VERSION="$(date +%Y%m%d-%H%M%S)"
        ZIP_NAME="PixelOS-SM8550-$KERNEL_VERSION"
        
        if [ "${{ inputs.enable_susfs }}" = "true" ]; then
            ZIP_NAME="${ZIP_NAME}-SUSFS"
        fi
        
        if [ "${{ inputs.enable_kpm }}" = "true" ]; then
            ZIP_NAME="${ZIP_NAME}-KPM"
        fi
        
        ZIP_NAME="${ZIP_NAME}.zip"
        
        # 创建ZIP文件
        zip -r9 "${GITHUB_WORKSPACE}/$ZIP_NAME" .
        
        echo "✅ ZIP包创建完成: $ZIP_NAME"
        ls -lh "${GITHUB_WORKSPACE}/$ZIP_NAME"
        
        echo "KERNEL_ZIP=$ZIP_NAME" >> $GITHUB_ENV

    - name: Create Release
      if: success()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "创建GitHub发布..."
        
        if [ -z "$KERNEL_ZIP" ]; then
            echo "❌ 未找到内核包"
            exit 1
        fi
        
        ZIP_PATH="${GITHUB_WORKSPACE}/$KERNEL_ZIP"
        
        if [ ! -f "$ZIP_PATH" ]; then
            echo "❌ ZIP文件不存在: $ZIP_PATH"
            exit 1
        fi
        
        # 生成版本标签
        TAG_NAME="kernel-$(date +%Y%m%d-%H%M)"
        
        # 创建发布说明
        RELEASE_NOTES=$(cat << EOF
        # PixelOS Kernel for OnePlus 12R (SM8550)
        
        ## 构建信息
        - 构建时间: $(date)
        - 配置文件: $CONFIG_FILE
        - 架构: $ARCH
        
        ## 功能支持
        - SUSFS: ${{ inputs.enable_susfs }}
        - KPM: ${{ inputs.enable_kpm }}
        
        ## 使用说明
        1. 下载 \`$KERNEL_ZIP\`
        2. 解压得到内核镜像和刷机脚本
        3. 按照刷机脚本说明刷入设备
        
        ## 注意事项
        - 刷机有风险，请提前备份重要数据
        - 仅适用于OnePlus 12R (SM8550)设备
        EOF
        )
        
        # 创建GitHub Release
        gh release create "$TAG_NAME" \
            --title "PixelOS Kernel $(date +%Y%m%d)" \
            --notes "$RELEASE_NOTES" \
            "$ZIP_PATH"
        
        echo "✅ 发布创建完成: $TAG_NAME"
