name: PixelOS_Kernel_CI-aston

on:
  workflow_dispatch:
    inputs:
      enable_susfs:
        description: '启用 SUSFS 支持'
        type: boolean
        default: true
      enable_kpm:
        description: '启用 KPM (内核模块) 支持'
        type: boolean
        default: true
      susfs_branch:
        description: 'SUSFS 分支名称 (使用 master 而不是 main)'
        type: string
        default: 'master'  # 修正：SUSFS 使用 master 分支
      kpm_type:
        description: 'KPM 实现类型'
        type: choice
        options:
          - kpatch
          - livepatch
          - basic
        default: 'basic'

jobs:
  PixelOS_Kernel_CI:
    name: PixelOS Kernel CI
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Clone Kernel and Dependencies
      run: |
        git clone https://github.com/OnePlus12R-development/android_kernel_oneplus_sm8550.git --depth=1 -b sixteen-qpr1 kernel/oneplus/sm8550
        git clone https://github.com/OnePlus12R-development/android_kernel_oneplus_sm8550-modules.git --depth=1 -b sixteen-qpr1 kernel/oneplus/sm8550-modules

    - name: Setup SUSFS Environment
      if: inputs.enable_susfs
      run: |
        echo "正在设置 SUSFS 环境..."
        
        # 修正：增强分支处理逻辑
        if git clone https://gitlab.com/simonpunk/susfs4ksu.git -b ${{ inputs.susfs_branch }} susfs_patches; then
            echo "✅ SUSFS 分支 ${{ inputs.susfs_branch }} 克隆成功"
        else
            echo "⚠️ 分支 ${{ inputs.susfs_branch }} 不存在，尝试默认的 master 分支"
            git clone https://gitlab.com/simonpunk/susfs4ksu.git -b master susfs_patches
        fi
        
        # 增加目录检查
        if [ -d "susfs_patches/kernel_patches" ]; then
            cp -r susfs_patches/kernel_patches/* kernel/oneplus/sm8550/
            echo "✅ SUSFS 补丁文件复制完成"
        else
            echo "❌ SUSFS 补丁目录不存在，检查仓库结构:"
            ls -la susfs_patches/
            exit 1
        fi

    - name: Setup KPM Environment  
      if: inputs.enable_kpm
      run: |
        echo "正在设置 KPM 环境..."
        
        # 修正：使用真实的 KPM 相关仓库
        case "${{ inputs.kpm_type }}" in
            "kpatch")
                echo "使用 kpatch 实现"
                git clone https://github.com/dynup/kpatch.git kpm_tools --depth=1
                ;;
            "livepatch")
                echo "使用 livepatch 实现"
                git clone https://github.com/openSUSE/kgraft.git kpm_tools --depth=1
                ;;
            *)
                echo "使用基础 KPROBES 支持"
                # 基础支持已在内核中，无需额外克隆
                mkdir -p kpm_tools
                ;;
        esac
        
        # 复制可能的 KPM 补丁或工具
        if [ -d "kpm_tools" ]; then
            find kpm_tools -name "*.patch" -exec cp {} kernel/oneplus/sm8550/ \; 2>/dev/null || echo "未找到补丁文件"
            echo "✅ KPM 环境设置完成"
        else
            echo "⚠️ KPM 工具目录创建失败，但继续执行"
        fi

    - name: Apply SUSFS Patches
      if: inputs.enable_susfs
      run: |
        cd kernel/oneplus/sm8550
        echo "应用 SUSFS 补丁..."
        
        # 增强补丁应用逻辑
        for patch_file in $(find . -name "*.patch" | head -10); do
            if [ -f "$patch_file" ]; then
                echo "尝试应用补丁: $(basename $patch_file)"
                if patch -p1 --dry-run < "$patch_file" 2>/dev/null; then
                    patch -p1 < "$patch_file"
                    echo "✅ 补丁应用成功: $(basename $patch_file)"
                else
                    echo "⚠️ 补丁可能已应用或存在冲突: $(basename $patch_file)"
                    # 尝试强制应用但允许失败
                    patch -p1 -f --no-backup-if-mismatch < "$patch_file" 2>/dev/null || true
                fi
            fi
        done
        echo "SUSFS 补丁处理完成"

    - name: Configure Kernel Options
      run: |
        cd kernel/oneplus/sm8550
        
        # 备份原始配置
        if [ -f "arch/arm64/configs/vendor/sm8550_defconfig" ]; then
            cp arch/arm64/configs/vendor/sm8550_defconfig arch/arm64/configs/vendor/sm8550_defconfig.backup
        fi
        
        # 基础配置
        {
            echo "CONFIG_MODULES=y"
            echo "CONFIG_MODULE_UNLOAD=y"
            echo "CONFIG_MODULE_FORCE_UNLOAD=y"
        } >> arch/arm64/configs/vendor/sm8550_defconfig
        
        # SUSFS 配置
        if [ "${{ inputs.enable_susfs }}" = "true" ]; then
            {
                echo "CONFIG_KSU_SUSFS=y"
                echo "CONFIG_KSU_SUSFS_SUS_PATH=y"
                echo "CONFIG_KSU_SUSFS_SUS_MAP=y"
                echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y"
                echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y"
            } >> arch/arm64/configs/vendor/sm8550_defconfig
            echo "✅ SUSFS 配置已添加"
        fi
        
        # KPM 配置 - 修正配置项
        if [ "${{ inputs.enable_kpm }}" = "true" ]; then
            {
                echo "CONFIG_KPROBES=y"
                echo "CONFIG_HAVE_KPROBES=y"
                echo "CONFIG_KPROBE_EVENTS=y"
                echo "CONFIG_OPTPROBES=y"
                echo "CONFIG_UPROBES=y"
            } >> arch/arm64/configs/vendor/sm8550_defconfig
            
            # 根据选择的 KPM 类型添加特定配置
            case "${{ inputs.kpm_type }}" in
                "kpatch")
                    echo "CONFIG_LIVEPATCH=y" >> arch/arm64/configs/vendor/sm8550_defconfig
                    echo "CONFIG_DYNAMIC_FTRACE=y" >> arch/arm64/configs/vendor/sm8550_defconfig
                    ;;
                "livepatch")
                    echo "CONFIG_LIVEPATCH=y" >> arch/arm64/configs/vendor/sm8550_defconfig
                    echo "CONFIG_FUNCTION_TRACER=y" >> arch/arm64/configs/vendor/sm8550_defconfig
                    ;;
            esac
            echo "✅ KPM 配置已添加"
        fi
        
        echo "内核配置更新完成"
        # 验证配置
        grep -E "CONFIG_(KSU_SUSFS|KPROBES|LIVEPATCH)" arch/arm64/configs/vendor/sm8550_defconfig || echo "未找到相关配置项"

    # 后续步骤保持不变，但优化构建参数传递
    - name: Build Kernel with ksu
      run: |
        cd kernel/oneplus/sm8550
        
        # 构建参数设置
        BUILD_ARGS="--clean --ksu"
        [ "${{ inputs.enable_susfs }}" = "true" ] && BUILD_ARGS="$BUILD_ARGS --susfs"
        [ "${{ inputs.enable_kpm }}" = "true" ] && BUILD_ARGS="$BUILD_ARGS --kpm"
        
        echo "构建参数: $BUILD_ARGS"
        build_sm8550 $BUILD_ARGS
        
        # 生成带功能标记的文件名
        FEATURE_TAG=""
        [ "${{ inputs.enable_susfs }}" = "true" ] && FEATURE_TAG="${FEATURE_TAG}_susfs"
        [ "${{ inputs.enable_kpm }}" = "true" ] && FEATURE_TAG="${FEATURE_TAG}_kpm"
        
        mv kernel.zip ${GITHUB_WORKSPACE}/ksu${FEATURE_TAG}.zip
        
        # 清理
        git clean -fdx
        find . -mindepth 1 -maxdepth 1 -type d -name ".git" -exec rm -rf {} \; 2>/dev/null || true
        git reset --hard

    # ksu-next 和 sukisu 的构建步骤类似优化...
    - name: Build Kernel with ksu-next
      run: |
        cd kernel/oneplus/sm8550
        BUILD_ARGS="--clean --ksu-next"
        [ "${{ inputs.enable_susfs }}" = "true" ] && BUILD_ARGS="$BUILD_ARGS --susfs"
        [ "${{ inputs.enable_kpm }}" = "true" ] && BUILD_ARGS="$BUILD_ARGS --kpm"
        
        build_sm8550 $BUILD_ARGS
        
        FEATURE_TAG=""
        [ "${{ inputs.enable_susfs }}" = "true" ] && FEATURE_TAG="${FEATURE_TAG}_susfs"
        [ "${{ inputs.enable_kpm }}" = "true" ] && FEATURE_TAG="${FEATURE_TAG}_kpm"
        
        mv kernel.zip ${GITHUB_WORKSPACE}/ksu-next${FEATURE_TAG}.zip
        git clean -fdx && find . -mindepth 1 -maxdepth 1 -type d -exec test -d "{}/.git" \; -print | xargs rm -rf && git reset --hard

    - name: Build Kernel with sukisu
      run: |
        cd kernel/oneplus/sm8550
        BUILD_ARGS="--clean --sukisu"
        [ "${{ inputs.enable_susfs }}" = "true" ] && BUILD_ARGS="$BUILD_ARGS --susfs"
        [ "${{ inputs.enable_kpm }}" = "true" ] && BUILD_ARGS="$BUILD_ARGS --kpm"
        
        build_sm8550 $BUILD_ARGS
        
        FEATURE_TAG=""
        [ "${{ inputs.enable_susfs }}" = "true" ] && FEATURE_TAG="${FEATURE_TAG}_susfs"
        [ "${{ inputs.enable_kpm }}" = "true" ] && FEATURE_TAG="${FEATURE_TAG}_kpm"
        
        mv kernel.zip ${GITHUB_WORKSPACE}/sukisu${FEATURE_TAG}.zip
        git clean -fdx && find . -mindepth 1 -maxdepth 1 -type d -exec test -d "{}/.git" \; -print | xargs rm -rf && git reset --hard

    - name: Create GitHub Release
      run: |
        cd ${GITHUB_WORKSPACE}
        RELEASE_FILES=$(ls *.zip 2>/dev/null | tr '\n' ' ' || echo "")
        if [ -z "$RELEASE_FILES" ]; then
            echo "❌ 未找到任何构建产物"
            exit 1
        fi
        
        echo "发布文件: $RELEASE_FILES"
        gh release create "$REL_NAME" --title "$REL_NAME" --notes "SUSFS: ${{ inputs.enable_susfs }}, KPM: ${{ inputs.enable_kpm }}, 类型: ${{ inputs.kpm_type }}" $RELEASE_FILES
