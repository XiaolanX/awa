name: PixelOS_Kernel_CI-aston

on:
  workflow_dispatch:

jobs:
  PixelOS_Kernel_CI:
    name: PixelOS Kernel CI
    # 核心修改：将自托管运行器改为 GitHub 托管的 Ubuntu 最新版本运行器
    runs-on: ubuntu-latest
    steps:

    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Clone Kernel and Dependencies
      run: |
        git clone https://github.com/OnePlus12R-development/android_kernel_oneplus_sm8550.git --depth=1 -b sixteen-qpr1 kernel/oneplus/sm8550
        git clone https://github.com/OnePlus12R-development/android_kernel_oneplus_sm8550-modules.git --depth=1 -b sixteen-qpr1 kernel/oneplus/sm8550-modules
    
    - name: Setup release name
      run: |
        rm -rf ${GITHUB_WORKSPACE}/*.zip
        cd kernel/oneplus/sm8550
        SUBLEVEL=$(grep "^SUBLEVEL =" Makefile | awk '{print $3}')
        REL_NAME="PixelOS_OPSM8550-v5.15.${SUBLEVEL}-$(date +"%Y%m%d")"
        echo "REL_NAME=${REL_NAME}" >> $GITHUB_ENV

    - name: Setup Build Environment
      run: |
        # 进入内核目录
        cd kernel/oneplus/sm8550
        
        # 尝试1：检查 build_sm8550 是否是一个本地脚本
        if [ -f "./build_sm8550" ]; then
          echo "找到本地构建脚本，赋予执行权限并添加到PATH"
          chmod +x ./build_sm8550
          echo "$(pwd)" >> $GITHUB_PATH  # 将当前目录添加到GITHUB_PATH中，后续步骤自动可用[6](@ref)
        
        # 尝试2：如果它不是文件，可能是一个需要安装的工具，这里可以安装依赖
        # 例如：sudo apt-get update && sudo apt-get install -y xxx
        else
          echo "错误：未找到 build_sm8550 脚本或可执行文件。"
          echo "当前目录内容："
          ls -la
          exit 1  # 主动报错，停止工作流
        fi

    - name: Build Kernel with ksu
      run: |
        cd kernel/oneplus/sm8550
        build_sm8550 --clean --ksu
        mv kernel.zip ${GITHUB_WORKSPACE}/ksu.zip
        git clean -fdx && find . -mindepth 1 -maxdepth 1 -type d -exec test -d "{}/.git" \; -print | xargs rm -rf && git reset --hard
        cd -

    - name: Build Kernel with ksu-next
      run: |
        cd kernel/oneplus/sm8550
        build_sm8550 --clean --ksu-next
        mv kernel.zip ${GITHUB_WORKSPACE}/ksu-next.zip
        git clean -fdx && find . -mindepth 1 -maxdepth 1 -type d -exec test -d "{}/.git" \; -print | xargs rm -rf && git reset --hard
        cd -

    - name: Build Kernel with sukisu
      run: |
        cd kernel/oneplus/sm8550
        # ... (此处是您添加的SUSFS和KPM配置代码，保持不变)
        DEFCONFIG_PATHS=(
          "arch/arm64/configs/oneplus_sm8550_defconfig"
          "arch/arm64/configs/vendor/sm8550_defconfig"
          "arch/arm64/configs/sm8550_defconfig"
        )
        for DEFCONFIG in "${DEFCONFIG_PATHS[@]}"; do
          if [ -f "$DEFCONFIG" ]; then
            echo "配置defconfig文件: $DEFCONFIG"
            echo "CONFIG_KPROBES=y" >> "$DEFCONFIG"
            # ... (其余配置选项)
            break
          fi
        done
        build_sm8550 --clean --sukisu
        mv kernel.zip ${GITHUB_WORKSPACE}/sukisu.zip
        git clean -fdx && find . -mindepth 1 -maxdepth 1 -type d -exec test -d "{}/.git" \; -print | xargs rm -rf && git reset --hard
        cd -

    - name: Create GitHub Release
      # 重要修改：为GitHub CLI提供认证令牌，以便创建Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cd ${GITHUB_WORKSPACE}
        gh release create "$REL_NAME" --title "$REL_NAME" --notes "" ksu.zip ksu-next.zip sukisu.zip
