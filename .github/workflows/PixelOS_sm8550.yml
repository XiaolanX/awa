name: PixelOS SM8550 GKI 2.0 Kernel Build

on:
  workflow_dispatch:
    inputs:
      enable_susfs:
        description: '启用 SUSFS 支持'
        type: boolean
        default: true
      enable_kpm:
        description: '启用 KPM 支持'
        type: boolean
        default: true
      susfs_branch:
        description: 'SUSFS 分支名称'
        type: string
        default: 'master'

jobs:
  build:
    name: Build PixelOS GKI 2.0 Kernel
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Install GKI 2.0 Build Dependencies
      run: |
        echo "安装GKI 2.0内核构建依赖..."
        sudo apt-get update
        sudo apt-get install -y \
            build-essential libssl-dev bc kmod \
            flex bison libelf-dev git ccache \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            binutils-aarch64-linux-gnu libncurses-dev \
            python3 python3-pip cpio lz4 device-tree-compiler \
            rsync wget curl \
            clang-15 lld-15 llvm-15 llvm-15-dev \
            dwarves
        
        # 设置LLVM 15工具链
        sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-15 100
        sudo update-alternatives --install /usr/bin/ld.lld ld.lld /usr/bin/ld.lld-15 100
        sudo update-alternatives --install /usr/bin/llvm-ar llvm-ar /usr/bin/llvm-ar-15 100
        sudo update-alternatives --install /usr/bin/llvm-strip llvm-strip /usr/bin/llvm-strip-15 100
        
        # 验证工具链
        echo "工具链版本:"
        aarch64-linux-gnu-gcc --version
        clang --version
        ld.lld --version
        llvm-ar --version
        echo "✅ GKI 2.0依赖安装完成"

    - name: Clone Kernel Source
      run: |
        echo "克隆内核源码..."
        rm -rf kernel_workspace
        mkdir -p kernel_workspace
        
        # 克隆内核源码
        git clone https://github.com/OnePlus12R-development/android_kernel_oneplus_sm8550-modules.git --depth=1 -b sixteen-qpr1 kernel_workspace/kernel/kernel/oplus_cpu
        git clone https://github.com/OnePlus12R-development/android_kernel_oneplus_sm8550.git \
            --depth=1 -b sixteen-qpr1 kernel_workspace/kernel
        
        if [ ! -d "kernel_workspace/kernel" ]; then
            echo "❌ 内核源码克隆失败"
            exit 1
        fi
        echo "✅ 内核源码克隆成功"
        
        # 检查GKI相关配置
        cd kernel_workspace/kernel
        echo "检查GKI相关配置:"
        grep -r "GKI\|KMI" arch/arm64/configs/ 2>/dev/null | head -10
        echo "检查内核版本:"
        grep -E "VERSION|PATCHLEVEL|SUBLEVEL" Makefile

    - name: Setup GKI 2.0 Build Environment
      id: gki_env
      run: |
        cd kernel_workspace/kernel
        echo "设置GKI 2.0构建环境..."
        
        # 获取内核版本
        KERNEL_VERSION=$(grep "^VERSION =" Makefile | awk '{print $3}' 2>/dev/null || echo "5")
        PATCHLEVEL=$(grep "^PATCHLEVEL =" Makefile | awk '{print $3}' 2>/dev/null || echo "10")
        SUBLEVEL=$(grep "^SUBLEVEL =" Makefile | awk '{print $3}' 2>/dev/null || echo "0")
        
        echo "内核版本: ${KERNEL_VERSION}.${PATCHLEVEL}.${SUBLEVEL}"
        
        # 检查GKI版本
        if [ -f "arch/arm64/configs/gki_defconfig" ]; then
            echo "找到gki_defconfig，检查是否支持GKI 2.0..."
            if grep -q "CONFIG_KMI_SYMBOL_LIST" arch/arm64/configs/gki_defconfig 2>/dev/null; then
                echo "✅ 检测到GKI 2.0+ 配置（包含KMI_SYMBOL_LIST）"
                echo "GKI_VERSION=2" >> $GITHUB_ENV
            else
                echo "⚠️ 未明确检测到GKI 2.0特定配置，可能为GKI 1.0"
                echo "GKI_VERSION=1" >> $GITHUB_ENV
            fi
            echo "DEFCONFIG_NAME=gki_defconfig" >> $GITHUB_ENV
        else
            echo "❌ 未找到gki_defconfig"
            exit 1
        fi
        
        # 设置构建环境变量
        echo "ARCH=arm64" >> $GITHUB_ENV
        echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
        echo "LLVM=1" >> $GITHUB_ENV
        echo "LLVM_IAS=1" >> $GITHUB_ENV
        echo "CC=clang" >> $GITHUB_ENV
        echo "LD=ld.lld" >> $GITHUB_ENV
        echo "AR=llvm-ar" >> $GITHUB_ENV
        echo "STRIP=llvm-strip" >> $GITHUB_ENV
        
        # 对于GKI 2.0，可能需要设置KMI版本
        echo "KERNEL_RELEASE=${KERNEL_VERSION}.${PATCHLEVEL}" >> $GITHUB_ENV
        echo "gki_version=$GKI_VERSION" >> $GITHUB_OUTPUT

    - name: Configure GKI 2.0 Kernel
      run: |
        cd kernel_workspace/kernel
        echo "配置GKI 2.0内核..."
        
        echo "GKI版本: ${{ env.GKI_VERSION }}"
        echo "内核版本: ${{ env.KERNEL_RELEASE }}"
        
        # 清理之前的构建
        make ARCH=${{ env.ARCH }} mrproper 2>/dev/null || echo "清理构建目录"
        
        # 应用gki_defconfig配置
        echo "应用gki_defconfig配置..."
        make ARCH=${{ env.ARCH }} ${{ env.DEFCONFIG_NAME }}
        
        if [ ! -f ".config" ]; then
            echo "❌ 配置失败，未生成.config文件"
            exit 1
        fi
        
        echo "✅ 初始配置完成"
        
        # 如果是GKI 2.0，确保相关配置
        if [ "${{ env.GKI_VERSION }}" = "2" ] || [ "${{ env.GKI_VERSION }}" = "2.0" ]; then
            echo "应用GKI 2.0特定配置..."
            
            # 启用GKI 2.0需要的选项
            ./scripts/config --enable GKI
            ./scripts/config --enable MODULES
            ./scripts/config --enable TRIM_UNUSED_KSYMS
            
            # KMI相关配置
            ./scripts/config --enable KMI_SYMBOL_LIST
            ./scripts/config --set-val KMI_SYMBOL_LIST_STRICT_MODE 0
            
            # 调试符号
            ./scripts/config --enable DEBUG_INFO
            ./scripts/config --enable DEBUG_INFO_DWARF_TOOLCHAIN_DEFAULT
            
            echo "✅ GKI 2.0配置应用完成"
        fi

    - name: Apply Kernel Customizations
      run: |
        cd kernel_workspace/kernel
        echo "应用内核定制配置..."
        
        # 启用模块支持
        ./scripts/config --enable MODULES
        ./scripts/config --enable MODULE_UNLOAD
        ./scripts/config --enable MODULE_FORCE_UNLOAD
        
        # 启用KPROBES（如果需要KPM）
        if [ "${{ inputs.enable_kpm }}" = "true" ]; then
            echo "启用KPROBES支持..."
            ./scripts/config --enable KPROBES
            ./scripts/config --enable HAVE_KPROBES
            ./scripts/config --enable KPROBE_EVENTS
            ./scripts/config --enable OPTPROBES
        fi
        
        # 生成最终配置
        echo "生成最终配置..."
        make ARCH=${{ env.ARCH }} olddefconfig
        
        echo "✅ 配置更新完成"
        
        # 显示关键配置状态
        echo "关键配置状态:"
        ./scripts/config --state GKI
        ./scripts/config --state MODULES
        ./scripts/config --state KMI_SYMBOL_LIST
        if [ "${{ inputs.enable_kpm }}" = "true" ]; then
            ./scripts/config --state KPROBES
        fi

    - name: Build GKI 2.0 Kernel
      run: |
        cd kernel_workspace/kernel
        echo "开始构建GKI 2.0内核..."
        
        # 显示详细环境
        echo "构建环境:"
        echo "ARCH: ${{ env.ARCH }}"
        echo "CROSS_COMPILE: ${{ env.CROSS_COMPILE }}"
        echo "CC: $(which ${{ env.CC }})"
        echo "GKI版本: ${{ env.GKI_VERSION }}"
        
        # 获取CPU核心数
        CORE_COUNT=$(nproc)
        echo "使用 $CORE_COUNT 个核心进行编译"
        
        # 构建内核Image
        echo "编译内核Image..."
        make ARCH=${{ env.ARCH }} \
             CC=${{ env.CC }} \
             LD=${{ env.LD }} \
             AR=${{ env.AR }} \
             STRIP=${{ env.STRIP }} \
             LLVM=1 \
             LLVM_IAS=1 \
             -j$CORE_COUNT \
             Image.gz-dtb
        
        # 检查构建结果
        echo "检查构建输出..."
        if [ -f "arch/arm64/boot/Image.gz-dtb" ]; then
            IMAGE_SIZE=$(stat -c%s "arch/arm64/boot/Image.gz-dtb")
            echo "✅ GKI 2.0内核构建成功"
            echo "  文件: arch/arm64/boot/Image.gz-dtb"
            echo "  大小: $IMAGE_SIZE 字节"
            
            # 检查是否有未压缩的Image
            if [ -f "arch/arm64/boot/Image" ]; then
                echo "  同时生成: arch/arm64/boot/Image"
            fi
        else
            echo "❌ 未找到内核镜像 (Image.gz-dtb)"
            echo "尝试编译标准Image..."
            make ARCH=${{ env.ARCH }} \
                 CC=${{ env.CC }} \
                 LD=${{ env.LD }} \
                 LLVM=1 \
                 LLVM_IAS=1 \
                 -j$CORE_COUNT \
                 Image
            
            if [ -f "arch/arm64/boot/Image" ]; then
                IMAGE_SIZE=$(stat -c%s "arch/arm64/boot/Image")
                echo "✅ 标准Image编译成功: $IMAGE_SIZE 字节"
            else
                echo "❌ 编译失败"
                exit 1
            fi
        fi
    - name: Check GKI Compatibility
      run: |
        cd kernel_workspace/kernel
        echo "检查GKI兼容性..."
        
        # 检查内核是否包含GKI模块支持
        echo "检查.config中的GKI相关配置:"
        grep -E "CONFIG_(GKI|KMI|ANDROID)" .config 2>/dev/null | head -20
        
        # 检查模块支持
        echo "检查模块支持:"
        grep -E "CONFIG_MODULES" .config 2>/dev/null
        
        # 如果编译了模块，检查模块目录
        if [ -d "modules" ]; then
            echo "找到内核模块:"
            ls modules/*.ko 2>/dev/null | head -5
        fi

    - name: Create GKI 2.0 Package
      run: |
        echo "创建GKI 2.0内核包..."
        
        PKG_DIR="${GITHUB_WORKSPACE}/gki2_package"
        mkdir -p "$PKG_DIR"
        
        cd kernel_workspace/kernel
        
        # 复制内核镜像
        if [ -f "arch/arm64/boot/Image.gz-dtb" ]; then
            cp arch/arm64/boot/Image.gz-dtb "$PKG_DIR/Image.gz-dtb"
            echo "复制: Image.gz-dtb"
        elif [ -f "arch/arm64/boot/Image" ]; then
            cp arch/arm64/boot/Image "$PKG_DIR/Image"
            echo "复制: Image"
        else
            echo "❌ 未找到内核镜像"
            exit 1
        fi
        
        # 复制配置文件
        cp .config "$PKG_DIR/kernel.config" 2>/dev/null || true
        
        # 复制模块（如果存在）
        if [ -d "modules" ] && [ -n "$(ls -A modules/*.ko 2>/dev/null)" ]; then
            mkdir -p "$PKG_DIR/modules"
            find modules -name "*.ko" -exec cp {} "$PKG_DIR/modules/" \;
            echo "复制内核模块"
        fi
        
        # 创建GKI 2.0版本信息
        cat > "$PKG_DIR/version.txt" << 'EOF'

    - name: Package and Release
      run: |
        echo "开始打包发布流程..."
        
        # 1. 准备目录
        PKG_DIR="${GITHUB_WORKSPACE}/gki2_package"
        cd "$PKG_DIR"
        
        # 2. 生成带时间戳的文件名
        DATE_TAG=$(date +%Y%m%d-%H%M)
        ZIP_NAME="PixelOS-SM8550-GKI2-${DATE_TAG}"
        
        # 根据输入参数调整文件名
        [[ "${{ inputs.enable_susfs }}" == "true" ]] && ZIP_NAME="${ZIP_NAME}-SUSFS"
        [[ "${{ inputs.enable_kpm }}" == "true" ]] && ZIP_NAME="${ZIP_NAME}-KPM"
        
        FINAL_ZIP="${GITHUB_WORKSPACE}/${ZIP_NAME}.zip"
        
        # 3. 执行压缩
        zip -r9 "$FINAL_ZIP" .
        
        echo "✅ 打包完成: ${ZIP_NAME}.zip"
        
        # 4. 创建发布 (使用环境变量规避 YAML 字符串解析问题)
        TAG_NAME="gki2-${DATE_TAG}"
        TITLE="PixelOS GKI 2.0 Kernel (${DATE_TAG})"
        NOTES="Built for SM8550. GKI Version: ${{ env.GKI_VERSION }}. SUSFS: ${{ inputs.enable_susfs }}, KPM: ${{ inputs.enable_kpm }}."
        
        # 使用 gh 命令行工具发布
        gh release create "$TAG_NAME" \
            "$FINAL_ZIP" \
            --title "$TITLE" \
            --notes "$NOTES" || echo "⚠️ Release 已经存在或创建失败，仅上传文件"
